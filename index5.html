<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Grocery Price Tracker</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js for Price History -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>

  <!-- 
    All styles are in this <style> block.
    The original app was designed for a mobile-first view (max-width: 480px).
  -->
  <style>
    body {
      box-sizing: border-box;
      font-family: Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f8fafc;
      color: #1e293b;
      height: 100%;
      overflow-x: hidden;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    .app-container {
      height: 100vh;
      display: flex;
      flex-direction: column;
      max-width: 480px;
      margin: 0 auto;
      background: white;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
    }

    .header {
      background: #3b82f6;
      color: white;
      padding: 0.75rem;
      text-align: center;
      position: relative;
    }

    .header h1 {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .header .subtitle {
      font-size: 0.8rem;
      opacity: 0.9;
      margin-top: 0.25rem;
    }

    .back-btn {
      position: absolute;
      left: 0.75rem;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: white;
      font-size: 1.25rem;
      cursor: pointer;
      padding: 0.25rem;
    }

    .country-selector {
      position: absolute;
      right: 0.75rem;
      top: 50%;
      transform: translateY(-50%);
    }

    .country-flag {
      background: none;
      border: none;
      color: white;
      font-size: 1.25rem;
      cursor: pointer;
      padding: 0.25rem;
      border-radius: 0.25rem;
      transition: background 0.2s;
    }

    .country-flag:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .country-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 0.5rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 9999;
      min-width: 150px;
      display: none;
      margin-top: 0.5rem;
    }

    .country-dropdown.active {
      display: block;
    }

    .country-option {
      padding: 0.6rem 0.75rem;
      cursor: pointer;
      color: #374151;
      font-size: 0.9rem;
      transition: background 0.2s;
      text-align: left;
    }

    .country-option:hover {
      background: #f1f5f9;
    }

    .country-option:first-child {
      border-radius: 0.5rem 0.5rem 0 0;
    }

    .country-option:last-child {
      border-radius: 0 0 0.5rem 0.5rem;
    }

    .main-content {
      flex: 1;
      overflow-y: auto;
      padding-bottom: 70px;
      width: 100%;
      max-width: 480px;
    }

    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      max-width: 480px;
      background: white;
      border-top: 1px solid #e2e8f0;
      display: flex;
      padding: 0.4rem 0;
      z-index: 10; /* Ensure nav is above other content */
    }

    .nav-item {
      flex: 1;
      text-align: center;
      padding: 0.4rem;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      background: none;
      color: #64748b;
    }

    .nav-item.active {
      color: #3b82f6;
    }

    .nav-item:hover {
      background: #f1f5f9;
    }

    .nav-icon {
      font-size: 1.1rem;
      margin-bottom: 0.2rem;
    }

    .nav-label {
      font-size: 0.7rem;
      font-weight: 500;
    }

    .quick-add-btn {
      background: rgba(255, 255, 255, 0.95);
      color: #374151 !important;
      border: 1px solid rgba(0, 0, 0, 0.08);
      border-radius: 16px;
      backdrop-filter: blur(10px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.06);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .quick-add-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(16, 185, 129, 0.05));
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .quick-add-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08), 0 2px 4px rgba(0, 0, 0, 0.06);
      border-color: rgba(59, 130, 246, 0.2);
    }

    .quick-add-btn:hover::before {
      opacity: 1;
    }

    .quick-add-btn .nav-icon {
      font-size: 1.1rem;
      font-weight: 300;
      position: relative;
      z-index: 1;
    }

    .quick-add-btn .nav-label {
      font-weight: 500;
      font-size: 0.65rem;
      position: relative;
      z-index: 1;
    }

    .screen {
      display: none;
      animation: fadeIn 0.3s ease-in-out;
    }

    .screen.active {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .search-bar {
      padding: 0.75rem;
      background: white;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .search-input {
      flex: 1;
      padding: 0.6rem;
      border: 1px solid #d1d5db;
      border-radius: 0.5rem;
      font-size: 0.9rem;
    }

    .search-add-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #10b981;
      color: white;
      border: none;
      font-size: 1.1rem;
      cursor: pointer;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .search-add-btn:hover {
      background: #059669;
      transform: scale(1.05);
    }

    .category-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 0.4rem;
      padding: 0.75rem;
      width: 100%;
      box-sizing: border-box;
    }

    .category-card {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 0.5rem;
      padding: 0.5rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      aspect-ratio: 1/1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      position: relative;
    }

    .category-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .category-card:hover .product-actions {
      opacity: 1;
    }

    .category-icon {
      font-size: 1.5rem;
      margin-bottom: 0.3rem;
    }

    .category-name {
      font-weight: 600;
      color: #1e293b;
      font-size: 0.65rem;
      line-height: 1.1;
      text-align: center;
    }

    .product-list {
      padding: 0.75rem;
    }

    .product-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 0.3rem;
      padding: 0.5rem;
      width: 100%;
      box-sizing: border-box;
    }

    .product-item {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 0.4rem;
      padding: 0.3rem;
      cursor: pointer;
      transition: all 0.2s;
      aspect-ratio: 1/1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      position: relative;
    }

    .product-item.list-style {
      aspect-ratio: auto;
      flex-direction: row;
      justify-content: space-between;
      align-items: center;
      text-align: left;
      padding: 0.75rem;
      margin-bottom: 0.5rem;
    }

    .product-item:hover {
      background: #f8fafc;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .product-item:hover .product-actions {
      opacity: 1;
    }

    .product-actions {
      position: absolute;
      top: 0.2rem;
      right: 0.2rem;
      display: flex;
      gap: 0.2rem;
      opacity: 0;
      transition: opacity 0.2s;
      z-index: 10;
    }
    
    /* NEW: Favorite Star Action - Moved to bottom left */
    .action-btn.favorite {
      background: none;
      color: #f59e0b; /* Yellow color */
      font-size: 0.9rem;
      width: 24px;
      height: 24px;
      position: absolute;
      bottom: 0.2rem; /* CHANGED FROM top */
      top: auto;      /* Ensures no conflict */
      left: 0.2rem;
      opacity: 1;
      box-shadow: none;
      transition: transform 0.2s, opacity 0.2s;
    }
    .action-btn.favorite:hover {
        transform: scale(1.1);
        background: rgba(255, 255, 255, 0.5);
    }

    .action-btn {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      font-size: 0.6rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .action-btn.add {
      background: #10b981;
      color: white;
    }

    .action-btn.duplicate {
      background: #3b82f6;
      color: white;
    }

    .action-btn.edit {
      background: #f59e0b;
      color: white;
    }

    .action-btn.delete {
      background: #ef4444;
      color: white;
    }

    .action-btn:hover {
      transform: scale(1.1);
    }

    .product-icon {
      font-size: 1.2rem;
      margin-bottom: 0.2rem;
    }

    .product-info h3 {
      font-weight: 600;
      margin-bottom: 0.1rem;
      font-size: 0.55rem;
      line-height: 1.0;
    }

    .product-item.list-style .product-info h3 {
      font-size: 0.9rem;
    }

    .product-meta {
      font-size: 0.5rem;
      color: #64748b;
    }

    .product-item.list-style .product-meta {
      font-size: 0.8rem;
    }

    .product-brand {
      font-size: 0.45rem;
      color: #64748b;
      font-style: italic;
      margin-top: 0.1rem;
    }

    .product-item.list-style .product-brand {
      font-size: 0.75rem;
    }

    .product-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 0.2rem;
      margin-top: 0.2rem;
    }

    .product-item.list-style .product-tags {
      margin-top: 0.3rem;
    }

    .tag {
      background: #e0f2fe;
      color: #0369a1;
      padding: 0.1rem 0.3rem;
      border-radius: 0.25rem;
      font-size: 0.4rem;
      font-weight: 500;
    }

    .product-item.list-style .tag {
      font-size: 0.7rem;
      padding: 0.15rem 0.4rem;
    }

    .price-info {
      text-align: center;
      margin-top: 0.1rem;
    }

    .product-item.list-style .price-info {
      text-align: right;
      margin-top: 0;
    }

    .price {
      font-weight: 600;
      color: #059669;
      font-size: 0.55rem;
    }

    .product-item.list-style .price {
      font-size: 0.9rem;
    }

    .ppu {
      font-size: 0.45rem;
      color: #64748b;
    }

    .product-item.list-style .ppu {
      font-size: 0.8rem;
    }

    .store-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 0.4rem;
      padding: 0.75rem;
      width: 100%;
      box-sizing: border-box;
    }

    .store-card {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 0.5rem;
      padding: 0.5rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      /* aspect-ratio: 1/1; <-- REMOVED */
      min-height: 120px; /* Added min-height instead */
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      position: relative;
    }

    .store-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .store-card:hover .product-actions {
      opacity: 1;
    }

    .store-initials {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.7rem;
      color: white;
      margin-bottom: 0.3rem;
    }

    .store-name {
      font-weight: 600;
      margin-bottom: 0.3rem;
      font-size: 0.65rem;
      text-align: center;
      line-height: 1.1;
    }

    .store-count {
      font-size: 0.6rem;
      color: #64748b;
    }

    .list-item {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 0.5rem;
      padding: 0.75rem;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      justify-content: space-between;
      /* New */
    }

    .list-item.checked {
      opacity: 0.6;
    }

    .list-item.checked .item-name {
      text-decoration: line-through;
    }

    .check-button {
      width: 2rem;
      height: 2rem;
      border-radius: 50%;
      border: 2px solid #10b981;
      background: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .check-button.checked {
      background: #10b981;
      color: white;
    }

    .check-button:hover {
      transform: scale(1.1);
    }

    .item-details {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      min-width: 0;
      /* New */
    }

    .item-name {
      font-weight: 600;
      margin-bottom: 0.2rem;
      font-size: 0.9rem;
      line-height: 1.2;
      white-space: nowrap;
      /* New */
      overflow: hidden;
      /* New */
      text-overflow: ellipsis;
      /* New */
    }

    .item-price-details {
      font-size: 0.8rem;
      color: #64748b;
      margin-top: 0.1rem;
      line-height: 1.4;
    }

    .item-store {
      color: #059669;
      font-weight: 500;
    }

    .item-total-price {
      font-weight: 600;
      color: #1e293b;
      margin-left: 0.5rem;
    }

    /* New styles for list item controls */
    .list-item-main {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex: 1;
      min-width: 0;
    }

    .list-item-icon {
      font-size: 1.5rem;
      flex-shrink: 0;
    }

    .list-item-controls {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-shrink: 0;
      /* Prevent controls from shrinking */
    }

    .qty-adjuster {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .qty-btn {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      border: 1px solid #d1d5db;
      background: white;
      color: #3b82f6;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      font-weight: 600;
      line-height: 1;
    }

    .qty-btn:hover {
      background: #f1f5f9;
    }

    .list-delete-btn {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      border: none;
      background: #f1f5f9;
      color: #ef4444;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .list-delete-btn:hover {
      background: #ef4444;
      color: white;
    }

    /* End new list item styles */

    .progress-bar {
      width: 100%;
      height: 0.4rem;
      background: #e2e8f0;
      border-radius: 0.25rem;
      overflow: hidden;
      margin-top: 0.4rem;
    }

    .progress-fill {
      height: 100%;
      background: #10b981;
      transition: width 0.3s ease;
    }

    .group-toggle {
      padding: 0.75rem;
      background: white;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .toggle-switch {
      position: relative;
      width: 40px;
      height: 22px;
      background: #d1d5db;
      border-radius: 11px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .toggle-switch.active {
      background: #3b82f6;
    }

    .toggle-knob {
      position: absolute;
      top: 2px;
      left: 2px;
      width: 18px;
      height: 18px;
      background: white;
      border-radius: 50%;
      transition: transform 0.2s;
    }

    .toggle-switch.active .toggle-knob {
      transform: translateX(18px);
    }

    .store-group {
      margin-bottom: 1rem;
    }

    .store-group-header {
      background: #f1f5f9;
      padding: 0.6rem 0.75rem;
      font-weight: 600;
      color: #374151;
      border-bottom: 1px solid #e2e8f0;
      font-size: 0.9rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      animation: fadeIn 0.3s ease-in-out;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 0.75rem;
      padding: 1.25rem;
      width: 90%;
      max-width: 350px;
      max-height: 80vh;
      overflow-y: auto;
      animation: scaleIn 0.3s ease-in-out;
    }

    @keyframes scaleIn {
      from {
        transform: scale(0.9);
        opacity: 0;
      }

      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .modal-title {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 1.25rem;
      cursor: pointer;
      color: #64748b;
    }

    .form-group {
      margin-bottom: 0.75rem;
      position: relative;
    }

    .form-label {
      display: block;
      margin-bottom: 0.4rem;
      font-weight: 600;
      color: #374151;
      font-size: 0.9rem;
    }

    .form-input {
      width: 100%;
      padding: 0.6rem;
      border: 1px solid #d1d5db;
      border-radius: 0.5rem;
      font-size: 0.9rem;
    }

    .form-select {
      width: 100%;
      padding: 0.6rem;
      border: 1px solid #d1d5db;
      border-radius: 0.5rem;
      font-size: 0.9rem;
      background: white;
    }

    .modal-actions {
      display: flex;
      gap: 0.6rem;
      margin-top: 1rem;
    }

    .modal-actions .btn {
      flex: 1;
    }

    .btn {
      padding: 0.6rem 1.2rem;
      border: none;
      border-radius: 0.5rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.9rem;
    }

    .btn-primary {
      background: #3b82f6;
      color: white;
    }

    .btn-primary:hover {
      background: #2563eb;
    }

    .btn-secondary {
      background: #10b981;
      color: white;
    }

    .btn-secondary:hover {
      background: #059669;
    }

    .btn-accent {
      background: #f59e0b;
      color: white;
    }

    .btn-accent:hover {
      background: #d97706;
    }

    .btn-outline {
      background: white;
      color: #3b82f6;
      border: 1px solid #3b82f6;
    }

    .btn-outline:hover {
      background: #3b82f6;
      color: white;
    }

    .btn-danger {
      background: #ef4444;
      color: white;
    }

    .btn-danger:hover {
      background: #dc2626;
    }

    .product-suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #d1d5db;
      border-top: none;
      border-radius: 0 0 0.5rem 0.5rem;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: none;
    }

    .suggestion-item {
      padding: 0.75rem;
      cursor: pointer;
      border-bottom: 1px solid #f1f5f9;
      transition: background 0.2s;
    }

    .suggestion-item:hover {
      background: #f8fafc;
    }

    .suggestion-item:last-child {
      border-bottom: none;
    }

    .suggestion-name {
      font-weight: 600;
      margin-bottom: 0.2rem;
    }

    .suggestion-category {
      font-size: 0.8rem;
      color: #64748b;
    }

    .search-results {
      padding: 0.75rem;
    }

    .search-section {
      margin-bottom: 1rem;
    }

    .search-section-title {
      font-weight: 600;
      color: #374151;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
      padding-left: 0.25rem;
    }

    .list-totals {
      font-size: 0.9rem;
      color: #64748b;
      margin-bottom: 0.75rem;
    }

    .list-totals h3 {
      font-size: 1.1rem;
      font-weight: 700;
      color: #1e293b;
      text-align: right;
    }

    .list-totals span {
      font-size: 0.9rem;
      color: #64748b;
      text-align: right;
      display: block;
    }

    .product-detail-screen {
      padding: 0.75rem;
    }

    .product-detail-header {
      text-align: center;
      margin-bottom: 1.5rem;
      padding: 1rem;
      background: white;
      border-radius: 0.5rem;
      border: 1px solid #e2e8f0;
      position: relative; /* Needed for absolute positioning of favorite button */
    }
    
    .chart-container {
        padding: 1rem 0;
        background: white;
        border-radius: 0.5rem;
        border: 1px solid #e2e8f0;
        margin-bottom: 1rem;
    }
    .chart-container h4 {
        font-weight: 600;
        font-size: 0.95rem;
        color: #374151;
        margin-bottom: 0.5rem;
        padding: 0 0.75rem;
    }

    .product-detail-icon {
      font-size: 3rem;
      margin-bottom: 0.5rem;
    }

    .product-detail-name {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    .product-detail-category {
      color: #64748b;
      font-size: 0.9rem;
    }

    .price-list {
      background: white;
      border-radius: 0.5rem;
      border: 1px solid #e2e8f0;
      overflow: hidden;
    }

    .price-list-header {
      background: #f8fafc;
      padding: 0.75rem;
      font-weight: 600;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .price-item {
      padding: 0.75rem;
      border-bottom: 1px solid #f1f5f9;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: background 0.2s;
    }

    .price-item:hover {
      background: #f8fafc;
    }

    .price-item:last-child {
      border-bottom: none;
    }

    .price-store-name {
      font-weight: 600;
      margin-bottom: 0.2rem;
    }

    .price-date {
      font-size: 0.8rem;
      color: #64748b;
    }

    .price-amount {
      text-align: right;
    }

    .price-value {
      font-weight: 600;
      color: #059669;
      font-size: 1rem;
    }

    .price-ppu {
      font-size: 0.8rem;
      color: #64748b;
    }

    .settings-list {
      padding: 0.75rem;
    }

    .setting-item {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 0.5rem;
      padding: 0.75rem;
      margin-bottom: 0.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: background 0.2s;
    }

    .setting-item:hover {
      background: #f8fafc;
    }

    .setting-label {
      font-weight: 600;
      font-size: 0.9rem;
    }

    .setting-value {
      color: #64748b;
      font-size: 0.8rem;
    }

    .toast {
      position: fixed;
      top: 1rem;
      left: 50%;
      transform: translateX(-50%);
      background: #059669;
      color: white;
      padding: 0.6rem 1.2rem;
      border-radius: 0.5rem;
      z-index: 2000;
      animation: slideInDown 0.3s ease-in-out;
      font-size: 0.9rem;
    }

    .toast.error {
      background: #dc2626;
    }

    @keyframes slideInDown {
      from {
        transform: translate(-50%, -100%);
      }

      to {
        transform: translate(-50%, 0);
      }
    }

    @keyframes slideOutUp {
      from {
        transform: translate(-50%, 0);
      }

      to {
        transform: translate(-50%, -100%);
      }
    }

    .loading {
      display: inline-block;
      width: 0.9rem;
      height: 0.9rem;
      border: 2px solid #f3f4f6;
      border-radius: 50%;
      border-top-color: #3b82f6;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .empty-state {
      text-align: center;
      padding: 2rem 1rem;
      color: #64748b;
    }

    .empty-icon {
      font-size: 2.5rem;
      margin-bottom: 0.75rem;
    }

    .shopping-list-item {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 0.75rem;
      padding: 1rem;
      margin-bottom: 0.75rem;
      display: flex;
      align-items: flex-start;
      gap: 1rem;
      transition: all 0.2s;
      cursor: pointer;
    }

    .shopping-list-item:hover {
      background: #f8fafc;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .list-icon {
      font-size: 2rem;
      flex-shrink: 0;
      margin-top: 0.25rem;
    }

    .list-content {
      flex: 1;
      min-width: 0;
    }

    .list-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 0.5rem;
    }

    .list-name {
      font-size: 1.1rem;
      font-weight: 600;
      color: #1e293b;
      margin: 0;
      line-height: 1.3;
    }

    .list-actions {
      display: flex;
      gap: 0.25rem;
      flex-shrink: 0;
      margin-left: 0.5rem;
    }

    .list-info {
      font-size: 0.9rem;
      color: #64748b;
      margin-bottom: 0.75rem;
    }
    
    /* NEW: Suggested Items Container */
    .suggested-items-container {
      padding: 0.75rem;
      background: #f1f5f9;
      border-bottom: 1px solid #e2e8f0;
      margin-bottom: 0.75rem;
    }
    .suggested-items-container h4 {
      font-weight: 600;
      font-size: 0.9rem;
      color: #374151;
      margin-bottom: 0.5rem;
    }
    .suggested-items-grid {
      display: flex;
      gap: 0.5rem;
      overflow-x: auto;
      padding-bottom: 0.2rem;
    }
    .suggested-item {
      flex-shrink: 0;
      width: 80px;
      text-align: center;
      background: white;
      border: 1px solid #cbd5e1;
      border-radius: 0.5rem;
      padding: 0.5rem 0.2rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .suggested-item:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .suggested-icon {
      font-size: 1.5rem;
      margin-bottom: 0.2rem;
    }
    .suggested-name {
      font-size: 0.65rem;
      font-weight: 500;
      line-height: 1.2;
      height: 1.8rem; /* Fixed height for two lines of text */
      overflow: hidden;
    }

    /* --- AUTH SCREEN STYLES --- */
    .auth-container {
        /* This container replaces the main-content for logged-out users */
        flex: 1;
        overflow-y: auto;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem 1rem 70px 1rem; 
        background: #f8fafc;
    }
    .auth-form-card {
        max-width: 350px;
        width: 100%;
        background: white;
        padding: 1.5rem;
        border-radius: 0.75rem;
        box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
    }
    .auth-mode-toggle button {
        /* Tailwind custom classes used for the switch bar */
        font-weight: 600;
    }
    .google-btn-svg {
        width: 20px;
        height: 20px;
        margin-right: 0.75rem;
    }
    .sign-out-btn {
      position: absolute;
      right: 0.75rem;
      top: 50%;
      transform: translateY(-50%);
      padding: 0.3rem 0.7rem;
      font-size: 0.8rem;
      font-weight: 500;
      background: #dc2626;
      color: white;
      border-radius: 0.5rem;
      cursor: pointer;
      transition: background 0.2s;
      border: none;
    }
    .auth-error-message {
      background: #fef2f2;
      border: 1px solid #fccbcb;
      color: #dc2626;
      padding: 0.5rem;
      border-radius: 0.5rem;
      text-align: center;
      margin-top: 0.75rem;
      font-size: 0.9rem;
    }
  </style>

</head>

<body>

  <!-- Main App Container -->
  <div class="app-container">

    <!-- Header -->
    <div class="header">
      <button class="back-btn" id="backBtn" style="display: none;">‚Üê</button>
      <h1 id="headerTitle">Grocery Price Tracker</h1>
      <div class="subtitle" id="headerSubtitle">Track prices and save money</div>
      <div class="country-selector" id="countrySelector">
        <button class="country-flag" id="countryFlag">üá®üá¶</button>
        <div class="country-dropdown" id="countryDropdown">
          <div class="country-option" data-region="CA">üá®üá¶ Canada</div>
          <div class="country-option" data-region="US">üá∫üá∏ United States</div>
          <div class="country-option" data-region="UK">üá¨üáß UK</div>
        </div>
      </div>
      <!-- Sign Out Button (Visible only when logged in) -->
      <button class="sign-out-btn" id="signOutBtn" style="display: none;">Sign Out</button>
      
      <!-- Test button removed -->
      
    </div>

    <!-- Main Content -->
    <!-- The main-content wrapper will now contain either the Auth Screen or the App Screens -->
    <div class="main-content">
      
      <!-- NEW: Authentication Screen (Screen ID: authScreen) -->
      <div class="screen active auth-container" id="authScreen">
          <div class="auth-form-card">
              <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">User Sign In</h2>
              
              <!-- UI: Simplified Switch Bar -->
              <div id="authModeToggle" class="auth-mode-toggle flex mb-6 rounded-lg bg-indigo-100 p-0.5">
                  <button data-mode="login" class="flex-1 py-2 text-sm font-bold rounded-lg bg-indigo-600 text-white shadow-md transition duration-200">
                      Sign In
                  </button>
                  <button data-mode="register" class="flex-1 py-2 text-sm font-bold rounded-lg text-indigo-700 hover:bg-white transition duration-200">
                      Register
                  </button>
              </div>
      
              <form id="authForm" class="space-y-4">
                  <div>
                      <label for="authEmail" class="block text-sm font-medium text-gray-700">Email Address</label>
                      <input type="email" id="authEmail" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-inner focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" disabled>
                  </div>
                  <div>
                      <label for="authPassword" class="block text-sm font-medium text-gray-700">Password</label>
                      <input type="password" id="authPassword" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-inner focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" disabled>
                      <p class="text-xs text-gray-400 mt-1">Password must be at least 6 characters.</p>
                  </div>
                  
                  <button type="submit" id="authSubmitBtn" class="w-full py-3 px-4 border border-transparent rounded-lg shadow-lg text-base font-semibold text-white bg-indigo-400 cursor-not-allowed transform hover:scale-[1.01] transition duration-200" disabled>
                      Sign In
                  </button>
                  <p id="authErrorMessage" class="auth-error-message hidden"></p>
              </form>

              <!-- Divider -->
              <div class="my-6 flex items-center">
                  <div class="flex-grow border-t border-gray-300"></div>
                  <span class="flex-shrink mx-4 text-gray-500 text-sm">OR</span>
                  <div class="flex-grow border-t border-gray-300"></div>
              </div>

              <!-- UI: Cleaner Google Button -->
              <button id="googleSignInBtn" class="w-full flex items-center justify-center py-3 px-4 border border-gray-300 rounded-lg shadow-md text-base font-medium text-gray-700 bg-gray-200 cursor-not-allowed transform hover:bg-gray-50 transition duration-200" disabled>
                  <!-- Google SVG Icon -->
                  <svg class="google-btn-svg" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                      <path d="M12 9.38v2.62h6.15c-.25 1.4-1.12 2.62-2.33 3.4l2.04 1.6C19.82 17.65 22 14.88 22 12c0-2.88-.75-5.5-2.06-7.79l-2.3 1.83C19.16 6.55 20 9.17 20 12c0 2.21-.6 4.31-1.63 6.1l-2.06-1.6c.86-1.5 1.34-3.23 1.34-5.02z" fill="#4285F4"/>
                      <path d="M11 20.84c.83 0 1.63-.14 2.39-.41l2.06 1.6c-1.28.84-2.78 1.27-4.45 1.27-2.92 0-5.5-.96-7.33-2.58l2.25-1.77C6.55 20.2 8.76 20.84 11 20.84z" fill="#34A853"/>
                      <path d="M4 12c0-1.21.31-2.37.86-3.4l-2.25-1.77C.88 8.08 0 9.98 0 12c0 2.02.66 3.92 1.85 5.58l2.25-1.77C4.31 14.37 4 13.21 4 12z" fill="#FBBC05"/>
                      <path d="M11 3.16c1.64 0 3.13.56 4.32 1.55l1.79-1.79C15.5 1.47 13.78.84 11 .84c-2.76 0-5.26 1.05-7.14 2.8L6.11 5.37C7.4 4.07 9.1 3.16 11 3.16z" fill="#EA4335"/>
                  </svg>
                  Continue with Google
              </button>
              <p id="initStatusMessage" class="text-indigo-500 text-sm text-center mt-4">Initializing Firebase...</p>
              
              <!-- User ID Display (for debugging/info) -->
              <div class="mt-4 text-center text-xs text-gray-500">
                Logged in as: <span id="userIdDisplay" class="font-mono break-all text-indigo-700">Not Logged In</span>
              </div>
          </div>
      </div>
      <!-- END Authentication Screen -->


      <!-- Categories Screen -->
      <div class="screen" id="categoriesScreen">
        <div class="search-bar">
          <input type="text" class="search-input" placeholder="Search categories and products..." id="categorySearch">
          <button class="search-add-btn" id="addCategoryBtn">+</button>
        </div>
        <div class="category-grid" id="categoryGrid">
          <!-- Categories will be populated here -->
        </div>
        <div class="search-results" id="searchResults" style="display: none;">
          <!-- Search results will be populated here -->
        </div>
      </div>

      <!-- Products Screen -->
      <div class="screen" id="productsScreen">
        <div class="search-bar">
          <input type="text" class="search-input" placeholder="Search products..." id="productSearch">
          <button class="search-add-btn" id="addProductBtn">+</button>
        </div>
        <div class="product-grid" id="productList">
          <!-- Products will be populated here -->
        </div>
      </div>

      <!-- Product Detail Screen -->
      <div class="screen" id="productDetailScreen">
        <div class="product-detail-screen">
          <div class="product-detail-header" id="productDetailHeader">
            <!-- Product details will be populated here -->
          </div>
          
          <!-- NEW: Price History Chart -->
          <div class="chart-container">
            <h4>Price History (Cheapest by Month)</h4>
            <div style="padding: 0 0.75rem;">
                <canvas id="priceHistoryChart"></canvas>
            </div>
          </div>
          <!-- END Price History Chart -->
          
          <div class="price-list">
            <div class="price-list-header">
              <span>Store Prices</span>
              <button class="search-add-btn" id="addPriceBtn">+</button>
            </div>
            <div id="pricesList">
              <!-- Prices will be populated here -->
            </div>
          </div>
        </div>
      </div>

      <!-- Stores Screen -->
      <div class="screen" id="storesScreen">
        <div class="search-bar">
          <input type="text" class="search-input" placeholder="Search stores..." id="storeSearch">
          <button class="search-add-btn" id="addStoreBtn">+</button>
        </div>
        <!-- Sort Toggle Container will be prepended here by JS -->
        <div class="store-grid" id="storeGrid">
          <!-- Stores will be populated here -->
        </div>
      </div>

      <!-- Store Detail Screen -->
      <div class="screen" id="storeDetailScreen">
        <!-- New Search Bar for adding price -->
        <div class="search-bar">
          <input type="text" class="search-input" placeholder="Search products to add price for..." id="storeProductSearch">
        </div>
        <div class="product-list" id="storeProductList">
          <!-- Store products (latest prices) will be populated here -->
        </div>
        <div class="search-results" id="storePriceSearchResults" style="display: none;">
          <!-- Product search results for adding price will be populated here -->
        </div>
      </div>

      <!-- Lists Screen -->
      <div class="screen" id="listsScreen">
        <div class="search-bar">
          <input type="text" class="search-input" placeholder="Search lists..." id="listSearch">
          <button class="search-add-btn" id="addListBtn">+</button>
        </div>
        <div class="product-list" id="listGrid">
          <!-- Lists will be populated here -->
        </div>
      </div>

      <!-- List Detail Screen -->
      <div class="screen" id="listDetailScreen">
        <div class="group-toggle">
          <div class="toggle-switch" id="groupToggle">
            <div class="toggle-knob"></div>
          </div>
          <span>Group by Store</span>
        </div>
        <div class="search-bar">
          <input type="text" class="search-input" placeholder="Search products to add..." id="listProductSearch">
        </div>
        
        <!-- Suggested Items Container (NEW) -->
        <div id="suggestedItemsContainer">
          <!-- Suggested items will be rendered here -->
        </div>
        <!-- END Suggested Items Container -->
        
        <div class="product-list" id="listItemsContainer">
          <!-- List items will be populated here -->
        </div>

        <!-- NEW TOTALS CONTAINER -->
        <div class="list-totals" id="listTotalContainer" style="padding: 1rem 0.75rem; border-top: 2px solid #e2e8f0; background: #f8fafc; margin-top: 0.5rem;">
          <!-- Total price will be injected here -->
        </div>

        <div class="search-results" id="listSearchResults" style="display: none;">
          <!-- Product search results will be populated here -->
        </div>
      </div>

      <!-- Settings Screen -->
      <div class="screen" id="settingsScreen">
        <div class="settings-list">
          <!-- New Favorites Setting Item -->
          <div class="setting-item" id="favoritesSetting">
            <div>
              <div class="setting-label">Manage Favorites</div>
              <div class="setting-value" id="favoriteCount">0 items</div>
            </div>
          </div>
          <!-- End New Favorites Setting Item -->
          
          <div class="setting-item" id="countrySetting">
            <div>
              <div class="setting-label">Country/Region</div>
              <div class="setting-value" id="currentCountry">üá®üá¶ Canada</div>
            </div>
          </div>
          <div class="setting-item" id="unitSetting">
            <div>
              <div class="setting-label">Price Per Unit</div>
              <div class="setting-value" id="currentUnit">kg</div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- NEW: Favorites Screen -->
      <div class="screen" id="favoritesScreen">
        <!-- Search Bar for adding to favorites -->
        <div class="search-bar">
            <input type="text" class="search-input" placeholder="Search products to add to favorites..." id="favoriteProductSearch">
        </div>
        
        <!-- Favorites List and Search Results -->
        <div class="product-list">
             <!-- Search results will be populated here -->
            <div class="product-grid" id="favoriteSearchResults" style="display: none;"></div>
            
             <!-- Favorite products list -->
            <div class="product-grid" id="favoritesList">
                <!-- Favorite products will be populated here in a 4-column grid -->
            </div>
        </div>
      </div>
      <!-- END Favorites Screen -->

    </div> <!-- End Main Content -->

    <!-- Bottom Navigation -->
    <div class="bottom-nav" id="bottomNav">
      <button class="nav-item active" data-screen="categories">
        <div class="nav-icon">üè™</div>
        <div class="nav-label">Products</div>
      </button>
      <button class="nav-item" data-screen="stores">
        <div class="nav-icon">üè¨</div>
        <div class="nav-label">Stores</div>
      </button>
      <button class="nav-item quick-add-btn" id="quickAddBtn">
        <div class="nav-icon">‚ûï</div>
        <div class="nav-label">Quick Add</div>
      </button>
      <button class="nav-item" data-screen="lists">
        <div class="nav-icon">üìù</div>
        <div class="nav-label">Lists</div>
      </button>
      <button class="nav-item" data-screen="settings">
        <div class="nav-icon">‚öôÔ∏è</div>
        <div class="nav-label">Settings</div>
      </button>
    </div>

  </div> <!-- End App Container -->

  <!-- Modals -->
  <div class="modal" id="addProductModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Add Product</h3>
        <button class="close-btn" onclick="closeModal('addProductModal')">√ó</button>
      </div>
      <div class="form-group">
        <label class="form-label">Product Name</label>
        <input type="text" class="form-input" id="newProductName" placeholder="Enter product name">
      </div>
      <div class="form-group">
        <label class="form-label">Brand (Optional)</label>
        <input type="text" class="form-input" id="newProductBrand" placeholder="Enter brand name">
      </div>
      <div class="form-group">
        <label class="form-label">Category</label>
        <select class="form-select" id="newProductCategory">
          <!-- Categories will be populated here -->
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Icon (Optional)</label>
        <input type="text" class="form-input" id="newProductIcon" placeholder="üçé" maxlength="2">
      </div>
      <div class="form-group">
        <label class="form-label">Tags (Optional)</label>
        <input type="text" class="form-input" id="newProductTags" placeholder="e.g. organic, gluten-free, vegan">
        <div style="font-size: 0.8rem; color: #64748b; margin-top: 0.25rem;">Separate multiple tags with commas</div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-outline" onclick="closeModal('addProductModal')">Cancel</button>
        <button class="btn btn-primary" id="saveProductBtn">Add Product</button>
      </div>
    </div>
  </div>

  <div class="modal" id="addPriceModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Add Price</h3>
        <button class="close-btn" onclick="closeModal('addPriceModal')">√ó</button>
      </div>
      <div class="form-group">
        <label class="form-label">Product</label>
        <input type="text" class="form-input" id="priceProductName" readonly>
      </div>
      <div class="form-group">
        <label class="form-label">Store</label>
        <select class="form-select" id="priceStore">
          <!-- Stores will be populated here -->
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Price</label>
        <input type="number" class="form-input" id="priceAmount" step="0.01" placeholder="0.00">
      </div>
      <div class="form-group">
        <label class="form-label">Quantity</label>
        <input type="number" class="form-input" id="priceQuantity" step="0.01" placeholder="1.00" value="1">
      </div>
      <div class="form-group">
        <label class="form-label">Unit</label>
        <select class="form-select" id="priceUnit">
          <option value="lb">lb</option>
          <option value="kg">kg</option>
          <option value="g">g</option>
          <option value="L">L</option>
          <option value="mL">mL</option>
          <option value="oz">oz</option>
          <option value="ea">ea</option>
        </select>
      </div>
      <div class="form-group">
        <div class="ppu" id="calculatedPPU">Price per unit: $0.00/kg</div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-outline" onclick="closeModal('addPriceModal')">Cancel</button>
        <button class="btn btn-primary" id="savePriceBtn">Save Price</button>
      </div>
    </div>
  </div>

  <div class="modal" id="addStoreModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Add Store</h3>
        <button class="close-btn" onclick="closeModal('addStoreModal')">√ó</button>
      </div>
      <div class="form-group">
        <label class="form-label">Store Name</label>
        <input type="text" class="form-input" id="newStoreName" placeholder="Enter store name">
      </div>
      <div class="modal-actions">
        <button class="btn btn-outline" onclick="closeModal('addStoreModal')">Cancel</button>
        <button class="btn btn-primary" id="saveStoreBtn">Add Store</button>
      </div>
    </div>
  </div>

  <div class="modal" id="addCategoryModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Add Category</h3>
        <button class="close-btn" onclick="closeModal('addCategoryModal')">√ó</button>
      </div>
      <div class="form-group">
        <label class="form-label">Category Name</label>
        <input type="text" class="form-input" id="newCategoryName" placeholder="Enter category name">
      </div>
      <div class="form-group">
        <label class="form-label">Icon (emoji)</label>
        <input type="text" class="form-input" id="newCategoryIcon" placeholder="üõí" maxlength="2">
      </div>
      <div class="modal-actions">
        <button class="btn btn-outline" onclick="closeModal('addCategoryModal')">Cancel</button>
        <button class="btn btn-primary" id="saveCategoryBtn">Add Category</button>
      </div>
    </div>
  </div>

  <div class="modal" id="addListModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Create Shopping List</h3>
        <button class="close-btn" onclick="closeModal('addListModal')">√ó</button>
      </div>
      <div class="form-group">
        <label class="form-label">List Name</label>
        <input type="text" class="form-input" id="newListName" placeholder="Enter list name">
      </div>
      <div class="modal-actions">
        <button class="btn btn-outline" onclick="closeModal('addListModal')">Cancel</button>
        <button class="btn btn-primary" id="saveListBtn">Create List</button>
      </div>
    </div>
  </div>

  <div class="modal" id="addToListModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Add to Shopping List</h3>
        <button class="close-btn" onclick="closeModal('addToListModal')">√ó</button>
      </div>
      <div class="form-group">
        <label class="form-label">Product</label>
        <input type="text" class="form-input" id="listProductName" readonly>
      </div>
      <div class="form-group">
        <label class="form-label">Quantity</label>
        <input type="number" class="form-input" id="listQuantity" value="1" min="1" step="1">
      </div>
      <div class="form-group">
        <label class="form-label">Choose List:</label>
        <button class="btn btn-primary" id="createNewListBtn" style="width: 100%; margin-bottom: 0.5rem;">Create New
          List</button>
        <button class="btn btn-outline" id="addToExistingBtn" style="width: 100%;">Add to Existing List</button>
      </div>
      <div class="form-group" id="existingListGroup" style="display: none;">
        <label class="form-label">Select List</label>
        <select class="form-select" id="existingListSelect">
          <!-- Lists will be populated here -->
        </select>
      </div>
      <div class="form-group" id="newListGroup" style="display: none;">
        <label class="form-label">New List Name</label>
        <input type="text" class="form-input" id="quickListName" placeholder="Enter list name">
      </div>
      <div class="modal-actions">
        <button class="btn btn-outline" onclick="closeModal('addToListModal')">Cancel</button>
        <button class="btn btn-primary" id="confirmAddToListBtn">Add</button>
      </div>
    </div>
  </div>

  <div class="modal" id="quickAddModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">üõí Quick Add Product &amp; Price</h3>
        <button class="close-btn" onclick="closeModal('quickAddModal')">√ó</button>
      </div>
      <div class="form-group">
        <label class="form-label">Product Name</label>
        <input type="text" class="form-input" id="quickProductName" placeholder="Enter product name" autocomplete="off">
        <div class="product-suggestions" id="productSuggestions"></div>
      </div>
      <div class="form-group">
        <label class="form-label">Brand (Optional)</label>
        <input type="text" class="form-input" id="quickProductBrand" placeholder="Enter brand name">
      </div>
      <div class="form-group">
        <label class="form-label">Category</label>
        <select class="form-select" id="quickProductCategory">
          <!-- Categories will be populated here -->
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Icon (Optional)</label>
        <input type="text" class="form-input" id="quickProductIcon" placeholder="üçé" maxlength="2">
      </div>
      <div class="form-group">
        <label class="form-label">Tags (Optional)</label>
        <input type="text" class="form-input" id="quickProductTags" placeholder="e.g. organic, gluten-free, vegan">
        <div style="font-size: 0.8rem; color: #64748b; margin-top: 0.25rem;">Separate multiple tags with commas</div>
      </div>
      <div class="form-group">
        <label class="form-label">Store</label>
        <select class="form-select" id="quickStore">
          <!-- Stores will be populated here -->
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Price</label>
        <input type="number" class="form-input" id="quickPrice" step="0.01" placeholder="0.00">
      </div>
      <div class="form-group">
        <label class="form-label">Quantity</label>
        <input type="number" class="form-input" id="quickQuantity" step="0.01" placeholder="1.00" value="1">
      </div>
      <div class="form-group">
        <label class="form-label">Unit</label>
        <select class="form-select" id="quickUnit">
          <option value="lb">lb</option>
          <option value="kg">kg</option>
          <option value="g">g</option>
          <option value="L">L</option>
          <option value="mL">mL</option>
          <option value="oz">oz</option>
          <option value="ea">ea</option>
        </select>
      </div>
      <div class="form-group">
        <div class="ppu" id="quickCalculatedPPU">Price per unit: $0.00/kg</div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-outline" onclick="closeModal('quickAddModal')">Cancel</button>
        <button class="btn btn-primary" id="saveQuickAddBtn">Save Product &amp; Price</button>
      </div>
    </div>
  </div>

  <div class="modal" id="deleteConfirmModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Confirm Delete</h3>
        <button class="close-btn" onclick="closeModal('deleteConfirmModal')">√ó</button>
      </div>
      <div class="form-group">
        <p id="deleteMessage">Are you sure you want to delete this item?</p>
      </div>
      <div class="modal-actions">
        <button class="btn btn-outline" onclick="closeModal('deleteConfirmModal')">Cancel</button>
        <button class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
      </div>
    </div>
  </div>

  <div class="modal" id="countryModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Select Country/Region</h3>
        <button class="close-btn" onclick="closeModal('countryModal')">√ó</button>
      </div>
      <div class="form-group">
        <label class="form-label">Select Country</label>
        <select class="form-select" id="countrySelect">
          <option value="CA">üá®üá¶ Canada</option>
          <option value="US">üá∫üá∏ United States</option>
          <option value="UK">üá¨üáß UK</option>
        </select>
      </div>
      <div class="modal-actions">
        <button class="btn btn-outline" onclick="closeModal('countryModal')">Cancel</button>
        <button class="btn btn-primary" id="saveCountryBtn">Save</button>
      </div>
    </div>
  </div>

  <div class="modal" id="unitModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Price Per Unit</h3>
        <button class="close-btn" onclick="closeModal('unitModal')">√ó</button>
      </div>
      <div class="form-group">
        <label class="form-label">Select Unit</label>
        <select class="form-select" id="unitSelect">
          <option value="lb">Pound (lb)</option>
          <option value="kg">Kilogram (kg)</option>
          <option value="g">Gram (g)</option>
          <option value="L">Liter (L)</option>
          <option value="mL">Milliliter (mL)</option>
          <option value="oz">Ounce (oz)</option>
          <option value="ea">Each (ea)</option>
        </select>
      </div>
      <div class="modal-actions">
        <button class="btn btn-outline" onclick="closeModal('unitModal')">Cancel</button>
        <button class="btn btn-primary" id="saveUnitBtn">Save</button>
      </div>
    </div>
  </div>

  <div class="modal" id="editListModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Edit Shopping List</h3>
        <button class="close-btn" onclick="closeModal('editListModal')">√ó</button>
      </div>
      <div class="form-group">
        <label class="form-label">List Name</label>
        <input type="text" class="form-input" id="editListName" placeholder="Enter list name">
      </div>
      <div class="modal-actions">
        <button class="btn btn-outline" onclick="closeModal('editListModal')">Cancel</button>
        <button class="btn btn-primary" id="updateListBtn">Update List</button>
      </div>
    </div>
  </div>

  <div class="modal" id="deleteListModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Delete Shopping List</h3>
        <button class="close-btn" onclick="closeModal('deleteListModal')">√ó</button>
      </div>
      <div class="form-group">
        <p id="deleteListMessage">Are you sure you want to delete this shopping list?</p>
        <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 0.5rem; padding: 0.75rem; margin-top: 0.5rem;">
          <div style="color: #dc2626; font-weight: 600; font-size: 0.9rem; margin-bottom: 0.25rem;">‚ö†Ô∏è Warning</div>
          <div style="color: #7f1d1d; font-size: 0.8rem;">This action cannot be undone. All items in this list will be
            permanently deleted.</div>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-outline" onclick="closeModal('deleteListModal')">Cancel</button>
        <button class="btn btn-danger" id="confirmDeleteListBtn">Delete List</button>
      </div>
    </div>
  </div>

  <div class="modal" id="editProductModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Edit Product</h3>
        <button class="close-btn" onclick="closeModal('editProductModal')">√ó</button>
      </div>
      <div class="form-group">
        <label class="form-label">Product Name</label>
        <input type="text" class="form-input" id="editProductName" placeholder="Enter product name">
      </div>
      <div class="form-group">
        <label class="form-label">Brand (Optional)</label>
        <input type="text" class="form-input" id="editProductBrand" placeholder="Enter brand name">
      </div>
      <div class="form-group">
        <label class="form-label">Category</label>
        <select class="form-select" id="editProductCategory">
          <!-- Categories will be populated here -->
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Icon (Optional)</label>
        <input type="text" class="form-input" id="editProductIcon" placeholder="üçé" maxlength="2">
      </div>
      <div class="form-group">
        <label class="form-label">Tags (Optional)</label>
        <input type="text" class="form-input" id="editProductTags" placeholder="e.g. organic, gluten-free, vegan">
        <div style="font-size: 0.8rem; color: #64748b; margin-top: 0.25rem;">Separate multiple tags with commas</div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-outline" onclick="closeModal('editProductModal')">Cancel</button>
        <button class="btn btn-primary" id="updateProductBtn">Update Product</button>
      </div>
    </div>
  </div>


  <div class="modal" id="editPriceModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="editPriceTitle">Edit Price</h3>
        <button class="close-btn" onclick="closeModal('editPriceModal')">√ó</button>
      </div>
      <div class="form-group">
        <label class="form-label">Product</label>
        <input type="text" class="form-input" id="editPriceProductName" readonly>
      </div>
      <div class="form-group">
        <label class="form-label">Store</label>
        <select class="form-select" id="editPriceStore">
          <!-- Stores will be populated here -->
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Price</label>
        <input type="number" class="form-input" id="editPriceAmount" step="0.01" placeholder="0.00">
      </div>
      <div class="form-group">
        <label class="form-label">Quantity</label>
        <input type="number" class="form-input" id="editPriceQuantity" step="0.01" placeholder="1.00" value="1">
      </div>
      <div class="form-group">
        <label class="form-label">Unit</label>
        <select class="form-select" id="editPriceUnit">
          <option value="lb">lb</option>
          <option value="kg">kg</option>
          <option value="g">g</option>
          <option value="L">L</option>
          <option value="mL">mL</option>
          <option value="oz">oz</option>
          <option value="ea">ea</option>
        </select>
      </div>
      <div class="form-group">
        <div class="ppu" id="editCalculatedPPU">Price per unit: $0.00/kg</div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-danger" id="deletePriceBtn">Delete Price</button>
        <button class="btn btn-primary" id="updatePriceBtn">Update Price</button>
      </div>
    </div>
  </div>

  <div class="modal" id="editStoreModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Edit Store</h3>
        <button class="close-btn" onclick="closeModal('editStoreModal')">√ó</button>
      </div>
      <div class="form-group">
        <label class="form-label">Store Name</label>
        <input type="text" class="form-input" id="editStoreName" placeholder="Enter store name">
      </div>
      <div class="modal-actions">
        <button class="btn btn-outline" onclick="closeModal('editStoreModal')">Cancel</button>
        <button class="btn btn-primary" id="updateStoreBtn">Update Store</button>
      </div>
    </div>
  </div>


  <!-- 
  ==============================================
  APP JAVASCRIPT
  ==============================================
  All the application logic is in this script tag.
  -->
  <script type="module">
    // --- FIREBASE IMPORTS (Modular CDN Style for Canvas) ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
        getAuth,
        signInWithCustomToken,
        signInAnonymously,
        onAuthStateChanged,
        signOut,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        GoogleAuthProvider,
        signInWithPopup
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
        getFirestore,
        collection,
        addDoc,
        updateDoc,
        deleteDoc,
        onSnapshot,
        doc,
        writeBatch,
        setLogLevel
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Global state
    let currentRegion = 'CA';
    let currentScreen = 'categories';
    let currentCategory = '';
    let currentStore = '';
    let currentList = '';
    let currentProduct = '';
    let currentUnit = 'kg';
    let groupByStore = false;
    let allData = []; // This will be our in-memory database, synced with Firestore
    let selectedProductForList = '';
    let currentEditingPrice = null; 
    let currentEditingStore = null;
    let storeSortOrder = 'name'; 
    let currentEditingProduct = null;
    let currentDeletingItem = null;
    let currentEditingList = null;
    let currentDeletingList = null;
    let db; // Firestore instance
    let auth; // Auth instance
    let userId = null; // Current authenticated user ID
    let isAuthReady = false; // Flag to ensure DB operations wait for auth
    let chartInstance = null; // Chart.js instance for price history
    let unsubscribeAll = []; // Array to hold all onSnapshot unsubscribe functions
    let authMode = 'login'; // 'login' or 'register'
    
    // --- MANDATORY CANVAS/USER CONFIGURATION ---
    // The APP_ID is critical for scoping data to this specific app environment
    const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    // HARDCODED USER FIREBASE CONFIGURATION (Your config from prior query)
    const FIREBASE_CONFIG = {
        apiKey: "AIzaSyCMbwVpWChw1acukAFPb68_RcvrCiLoHgQ",
        authDomain: "grocery-pricecheck.firebaseapp.com",
        projectId: "grocery-pricecheck",
        storageBucket: "grocery-pricecheck.firebasestorage.app",
        messagingSenderId: "65520577405",
        appId: "1:65520577405:web:56b4a139369426b25bfa14",
        measurementId: "G-BHRV11JC2N"
    };

    // The token is provided by the Canvas environment, use if available
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    const IS_CONFIG_VALID = FIREBASE_CONFIG && typeof FIREBASE_CONFIG === 'object' && FIREBASE_CONFIG.apiKey;
    // --- END CONFIGURATION ---

    // UI Elements for Auth/App Switching
    const authScreenEl = document.getElementById('authScreen');
    const bottomNavEl = document.getElementById('bottomNav');
    const signOutBtnEl = document.getElementById('signOutBtn');
    const authModeToggleEl = document.getElementById('authModeToggle');
    const authFormEl = document.getElementById('authForm');
    const authEmailInput = document.getElementById('authEmail');
    const authPasswordInput = document.getElementById('authPassword');
    const authSubmitBtnEl = document.getElementById('authSubmitBtn');
    const authErrorEl = document.getElementById('authErrorMessage');
    const googleSignInBtnEl = document.getElementById('googleSignInBtn');
    const initStatusMessageEl = document.getElementById('initStatusMessage');
    const userIdDisplayEl = document.getElementById('userIdDisplay'); // NEW: For displaying user ID on Auth Screen

    // Default configuration (replaces elementSdk)
    const defaultConfig = {
      app_title: "Grocery Price Tracker",
      welcome_message: "Track prices and save money",
      primary_color: "#3b82f6",
      secondary_color: "#10b981",
      accent_color: "#f59e0b"
    };

    // Complete predefined data (EXPANDED TO BE A BETTER DATABASE)
    const categories = {
      'Fresh Fruit': {
        icon: 'üçé',
        products: ['Fuji Apples', 'Cavendish Bananas', 'Hass Avocados', 'Roma Tomatoes', 'Blueberries', 'Strawberries', 'Seedless Grapes (Red)', 'Oranges (Navel)', 'Lemons', 'Limes', 'Pears (Bartlett)', 'Kiwi Fruit', 'Mangoes', 'Pineapple', 'Watermelon']
      },
      'Fresh Vegetables': {
        icon: 'ü•ï',
        products: ['Organic Carrots', 'Russet Potatoes', 'Yellow Onions', 'White Onions', 'Garlic', 'Organic Spinach', 'Romaine Lettuce', 'Bell Peppers (Red)', 'Broccoli Florets', 'Cucumbers', 'Celery Sticks', 'Zucchini', 'Mushrooms (White)', 'Asparagus', 'Sweet Potatoes']
      },
      'Herbs & Spices': {
        icon: 'üåø',
        products: ['Dried Basil', 'Ground Cinnamon', 'Black Peppercorns', 'Sea Salt', 'Italian Seasoning', 'Garlic Powder', 'Dried Oregano', 'Fresh Cilantro', 'Fresh Parsley', 'Fresh Thyme']
      },
      'Dairy & Eggs': {
        icon: 'ü•õ',
        products: ['2% Milk (Lactaid)', 'Unsalted Butter', 'Large White Eggs (Dozen)', 'Sharp Cheddar Block', 'Greek Yogurt (Plain)', 'Cottage Cheese', 'Sour Cream', 'Cream Cheese (Block)', 'Heavy Cream (35%)', 'Almond Milk (Unsweetened)']
      },
      'Cheese (Specialty)': {
        icon: 'üßÄ',
        products: ['Parmesan Wedge', 'Mozzarella (Fresh)', 'Feta Crumbles', 'Goat Cheese Log', 'Brie Wheel', 'Havarti Slices']
      },
      'Deli Meats': {
        icon: 'ü•ì',
        products: ['Black Forest Ham (Sliced)', 'Smoked Turkey Breast', 'Roast Beef (Thin Sliced)', 'Prosciutto', 'Salami (Genoa)', 'Pepperoni Sticks']
      },
      'Fresh Bread & Rolls': {
        icon: 'üçû',
        products: ['Sourdough Loaf', 'Whole Wheat Bread', 'Plain Bagels (Pre-sliced)', 'Croissants (Butter)', 'Ciabatta Rolls', 'Hot Dog Buns']
      },
      'Grains & Flour': {
        icon: 'üåæ',
        products: ['All-Purpose Flour (5lb Bag)', 'Bread Flour', 'Basmati Rice (Dry)', 'Brown Rice (Dry)', 'Quinoa (Dry)', 'Couscous (Dry)', 'Oatmeal (Quick Oats)', 'Corn Meal']
      },
      'Pasta & Noodles': {
        icon: 'üçù',
        products: ['Spaghetti (Dried)', 'Penne Pasta (Dried)', 'Egg Noodles', 'Lasagna Sheets', 'Ramen Noodle Packs (Chicken)', 'Tortellini (Refrigerated)']
      },
      'Canned Goods': {
        icon: 'ü•´',
        products: ['Canned Black Beans', 'Canned Diced Tomatoes', 'Canned Whole Kernel Corn', 'Canned Chicken Broth', 'Canned Tuna in Water', 'Canned Salmon', 'Canned Green Beans']
      },
      'Jams & Spreads': {
        icon: 'üçØ',
        products: ['Peanut Butter (Creamy)', 'Almond Butter', 'Strawberry Jam', 'Grape Jelly', 'Honey (Bear Bottle)', 'Hazelnut Spread']
      },
      'Baking Supplies': {
        icon: 'üßÅ',
        products: ['Granulated Sugar (4lb Bag)', 'Brown Sugar (Light)', 'Baking Powder', 'Baking Soda', 'Vanilla Extract', 'Semi-Sweet Chocolate Chips', 'Yeast Packets']
      },
      'Snacks & Cookies': {
        icon: 'üç™',
        products: ['Potato Chips (Salted)', 'Pretzel Twists', 'Tortilla Chips (Restaurant Style)', 'Crackers (Saltines)', 'Chocolate Sandwich Cookies', 'Oatmeal Raisin Cookies']
      },
      'Nuts & Dried Fruit': {
        icon: 'üå∞',
        products: ['Almonds (Raw)', 'Cashews (Roasted/Salted)', 'Walnut Halves', 'Peanut Halves', 'Raisins (Seedless)', 'Dried Cranberries', 'Pistachios (Shelled)']
      },
      'Frozen Meals': {
        icon: 'üçï',
        products: ['Frozen Pizza (Pepperoni)', 'Frozen Lasagna Dinner', 'Frozen Chicken Pot Pie', 'Frozen Burrito Bowl']
      },
      'Frozen Sides & Desserts': {
        icon: 'üç¶',
        products: ['French Fries (Shoestring)', 'Frozen Broccoli Florets', 'Vanilla Ice Cream (Half Gallon)', 'Frozen Waffles', 'Frozen Mixed Berries']
      },
      'Condiments & Dressings': {
        icon: 'ü•ó',
        products: ['Ketchup (Large Bottle)', 'Mayonnaise (Jar)', 'Ranch Dressing', 'Italian Dressing', 'Dijon Mustard', 'Yellow Mustard', 'BBQ Sauce (Hickory)']
      },
      'Oils & Vinegars': {
        icon: 'üçæ',
        products: ['Extra Virgin Olive Oil', 'Canola Oil', 'Balsamic Vinegar', 'White Vinegar', 'Soy Sauce', 'Hot Sauce (Sriracha)']
      },
      'Beverages': {
        icon: 'ü•§',
        products: ['Bottled Water (24-Pack)', 'Orange Juice (Pulp-Free)', 'Sparkling Water (Lime)', 'Ground Coffee (Medium Roast)', 'Black Tea Bags (100ct)', 'Soda (Cola 12-Pack)']
      },
      'Personal Care': {
        icon: 'üß¥',
        products: ['Toothpaste (Mint)', 'Shampoo (Moisture)', 'Conditioner (Moisture)', 'Bar Soap (Unscented)', 'Razor Blades (5-Pack)', 'Hand Lotion', 'Sunscreen SPF 30']
      },
      'Household Supplies': {
        icon: 'üßπ',
        products: ['Dish Soap (Dawn)', 'Laundry Detergent (Liquid)', 'Paper Towels (12 Rolls)', 'Trash Bags (Tall Kitchen)', 'All-Purpose Cleaner Spray', 'Sponges (3-Pack)', 'Aluminium Foil']
      },
      'Red Meat': {
        icon: 'ü•©',
        products: ['Ground Beef 80/20 (1lb)', 'Beef Sirloin Steak', 'Pork Chops (Bone-in)', 'Bacon (Thick Cut)', 'Italian Sausage (Mild)', 'Lamb Shoulder Roast']
      },
      'Poultry': {
        icon: 'üçó',
        products: ['Chicken Breast Boneless/Skinless', 'Whole Chicken (Roaster)', 'Chicken Thighs', 'Ground Turkey (93% Lean)', 'Chicken Wings (Frozen)']
      },
      'Seafood': {
        icon: 'üç§',
        products: ['Wild Salmon Fillets (Fresh)', 'Jumbo Shrimp (Frozen)', 'Cod Fillets (Frozen)', 'Mussels (Fresh)', 'Oysters (Dozen)', 'Tuna Steaks (Frozen)']
      },
      'Cereal & Granola': {
        icon: 'ü•£',
        products: ['Frosted Flakes', 'Honey Nut Cheerios', 'Plain Oatmeal', 'Maple & Brown Sugar Oatmeal', 'Granola (Honey Almond)']
      }
    };

    // Product icons mapping (Expanded to match the new, larger list)
    const productIcons = {
      // Fresh Fruit
      'Fuji Apples': 'üçé',
      'Cavendish Bananas': 'üçå',
      'Hass Avocados': 'ü•ë',
      'Roma Tomatoes': 'üçÖ',
      'Blueberries': 'ü´ê',
      'Strawberries': 'üçì',
      'Seedless Grapes (Red)': 'üçá',
      'Oranges (Navel)': 'üçä',
      'Lemons': 'üçã',
      'Limes': 'üü¢',
      'Pears (Bartlett)': 'üçê',
      'Kiwi Fruit': 'ü•ù',
      'Mangoes': 'ü•≠',
      'Pineapple': 'üçç',
      'Watermelon': 'üçâ',

      // Fresh Vegetables
      'Organic Carrots': 'ü•ï',
      'Russet Potatoes': 'ü•î',
      'Yellow Onions': 'üßÖ',
      'White Onions': 'üßÖ',
      'Garlic': 'üßÑ',
      'Organic Spinach': 'ü•¨',
      'Romaine Lettuce': 'ü•¨',
      'Bell Peppers (Red)': 'ü´ë',
      'Broccoli Florets': 'ü•¶',
      'Cucumbers': 'ü•í',
      'Celery Sticks': 'ü•¨',
      'Zucchini': 'ü•í',
      'Mushrooms (White)': 'üçÑ',
      'Asparagus': 'üåø',
      'Sweet Potatoes': 'üç†',

      // Herbs & Spices
      'Dried Basil': 'üåø',
      'Ground Cinnamon': 'üå∞',
      'Black Peppercorns': 'üßÇ',
      'Sea Salt': 'üßÇ',
      'Italian Seasoning': 'üåø',
      'Garlic Powder': 'üßÑ',
      'Dried Oregano': 'üåø',
      'Fresh Cilantro': 'üåø',
      'Fresh Parsley': 'üåø',
      'Fresh Thyme': 'üåø',

      // Dairy & Eggs
      '2% Milk (Lactaid)': 'ü•õ',
      'Unsalted Butter': 'üßà',
      'Large White Eggs (Dozen)': 'ü•ö',
      'Sharp Cheddar Block': 'üßÄ',
      'Greek Yogurt (Plain)': 'üç¶',
      'Cottage Cheese': 'ü•õ',
      'Sour Cream': 'ü•Ñ',
      'Cream Cheese (Block)': 'üßÄ',
      'Heavy Cream (35%)': 'ü•õ',
      'Almond Milk (Unsweetened)': 'ü•õ',

      // Cheese (Specialty)
      'Parmesan Wedge': 'üßÄ',
      'Mozzarella (Fresh)': 'üßÄ',
      'Feta Crumbles': 'üßÄ',
      'Goat Cheese Log': 'üßÄ',
      'Brie Wheel': 'üßÄ',
      'Havarti Slices': 'üßÄ',

      // Deli Meats
      'Black Forest Ham (Sliced)': 'üçñ',
      'Smoked Turkey Breast': 'ü¶É',
      'Roast Beef (Thin Sliced)': 'ü•©',
      'Prosciutto': 'ü•ì',
      'Salami (Genoa)': 'üçï',
      'Pepperoni Sticks': 'üçï',

      // Fresh Bread & Rolls
      'Sourdough Loaf': 'üçû',
      'Whole Wheat Bread': 'üçû',
      'Plain Bagels (Pre-sliced)': 'ü•Ø',
      'Croissants (Butter)': 'ü•ê',
      'Ciabatta Rolls': 'ü•ñ',
      'Hot Dog Buns': 'üå≠',

      // Grains & Flour
      'All-Purpose Flour (5lb Bag)': 'üåæ',
      'Bread Flour': 'üåæ',
      'Basmati Rice (Dry)': 'üçö',
      'Brown Rice (Dry)': 'üçö',
      'Quinoa (Dry)': 'üçö',
      'Couscous (Dry)': 'üçö',
      'Oatmeal (Quick Oats)': 'ü•£',
      'Corn Meal': 'üåΩ',

      // Pasta & Noodles
      'Spaghetti (Dried)': 'üçù',
      'Penne Pasta (Dried)': 'üçù',
      'Egg Noodles': 'üçú',
      'Lasagna Sheets': 'üçù',
      'Ramen Noodle Packs (Chicken)': 'üçú',
      'Tortellini (Refrigerated)': 'üçù',

      // Canned Goods
      'Canned Black Beans': 'ü´ò',
      'Canned Diced Tomatoes': 'ü•´',
      'Canned Whole Kernel Corn': 'üåΩ',
      'Canned Chicken Broth': 'üç≤',
      'Canned Tuna in Water': 'üêü',
      'Canned Salmon': 'üêü',
      'Canned Green Beans': 'ü•´',

      // Jams & Spreads
      'Peanut Butter (Creamy)': 'ü•ú',
      'Almond Butter': 'ü•ú',
      'Strawberry Jam': 'üçì',
      'Grape Jelly': 'üçá',
      'Honey (Bear Bottle)': 'üçØ',
      'Hazelnut Spread': 'üç´',

      // Baking Supplies
      'Granulated Sugar (4lb Bag)': 'üçö',
      'Brown Sugar (Light)': 'üçØ',
      'Baking Powder': 'üßÅ',
      'Baking Soda': 'üßÅ',
      'Vanilla Extract': 'üåø',
      'Semi-Sweet Chocolate Chips': 'üç´',
      'Yeast Packets': 'üçû',

      // Snacks & Cookies
      'Potato Chips (Salted)': 'üçø',
      'Pretzel Twists': 'ü•®',
      'Tortilla Chips (Restaurant Style)': 'üåÆ',
      'Crackers (Saltines)': 'üç™',
      'Chocolate Sandwich Cookies': 'üç™',
      'Oatmeal Raisin Cookies': 'üç™',

      // Nuts & Dried Fruit
      'Almonds (Raw)': 'üå∞',
      'Cashews (Roasted/Salted)': 'üå∞',
      'Walnut Halves': 'üå∞',
      'Peanut Halves': 'ü•ú',
      'Raisins (Seedless)': 'üçá',
      'Dried Cranberries': 'üçí',
      'Pistachios (Shelled)': 'üü¢',

      // Frozen Meals
      'Frozen Pizza (Pepperoni)': 'üçï',
      'Frozen Lasagna Dinner': 'üçù',
      'Frozen Chicken Pot Pie': 'ü•ß',
      'Frozen Burrito Bowl': 'üåØ',

      // Frozen Sides & Desserts
      'French Fries (Shoestring)': 'üçü',
      'Frozen Broccoli Florets': 'ü•¶',
      'Vanilla Ice Cream (Half Gallon)': 'üç¶',
      'Frozen Waffles': 'üßá',
      'Frozen Mixed Berries': 'ü´ê',

      // Condiments & Dressings
      'Ketchup (Large Bottle)': 'üçÖ',
      'Mayonnaise (Jar)': 'ü•ö',
      'Ranch Dressing': 'ü•ó',
      'Italian Dressing': 'üáÆüáπ',
      'Dijon Mustard': 'üå≠',
      'Yellow Mustard': 'üå≠',
      'BBQ Sauce (Hickory)': 'üî•',

      // Oils & Vinegars
      'Extra Virgin Olive Oil': 'üçæ',
      'Canola Oil': 'üçæ',
      'Balsamic Vinegar': 'üçæ',
      'White Vinegar': 'üç∂',
      'Soy Sauce': 'ü•¢',
      'Hot Sauce (Sriracha)': 'üå∂Ô∏è',

      // Beverages
      'Bottled Water (24-Pack)': 'üíß',
      'Orange Juice (Pulp-Free)': 'üçä',
      'Sparkling Water (Lime)': 'ü•§',
      'Ground Coffee (Medium Roast)': '‚òï',
      'Black Tea Bags (100ct)': 'ü´ñ',
      'Soda (Cola 12-Pack)': 'ü•§',

      // Personal Care
      'Toothpaste (Mint)': 'ü¶∑',
      'Shampoo (Moisture)': 'üß¥',
      'Conditioner (Moisture)': 'üß¥',
      'Bar Soap (Unscented)': 'üßº',
      'Razor Blades (5-Pack)': 'ü™í',
      'Hand Lotion': 'üß¥',
      'Sunscreen SPF 30': 'üß¥',

      // Household Supplies
      'Dish Soap (Dawn)': 'üßΩ',
      'Laundry Detergent (Liquid)': 'üß∫',
      'Paper Towels (12 Rolls)': 'üìÑ',
      'Trash Bags (Tall Kitchen)': 'üóëÔ∏è',
      'All-Purpose Cleaner Spray': 'üßπ',
      'Sponges (3-Pack)': 'üßΩ',
      'Aluminium Foil': 'üç¥',

      // Red Meat
      'Ground Beef 80/20 (1lb)': 'ü•©',
      'Beef Sirloin Steak': 'ü•©',
      'Pork Chops (Bone-in)': 'üçñ',
      'Bacon (Thick Cut)': 'ü•ì',
      'Italian Sausage (Mild)': 'üå≠',
      'Lamb Shoulder Roast': 'üêè',

      // Poultry
      'Chicken Breast Boneless/Skinless': 'üçó',
      'Whole Chicken (Roaster)': 'üêî',
      'Chicken Thighs': 'üçó',
      'Ground Turkey (93% Lean)': 'ü¶É',
      'Chicken Wings (Frozen)': 'üçó',

      // Seafood
      'Wild Salmon Fillets (Fresh)': 'üêü',
      'Jumbo Shrimp (Frozen)': 'üç§',
      'Cod Fillets (Frozen)': 'üêü',
      'Mussels (Fresh)': 'üêö',
      'Oysters (Dozen)': 'ü¶™',
      'Tuna Steaks (Frozen)': 'üêü',
      
      // Cereal & Granola
      'Frosted Flakes': 'ü•£',
      'Honey Nut Cheerios': 'ü•£',
      'Plain Oatmeal': 'ü•£',
      'Maple & Brown Sugar Oatmeal': 'ü•£',
      'Granola (Honey Almond)': 'ü•£',
      // Default icon
      'Unknown': 'üì¶'
    };
    
    // Essential products list for suggestions (for non-favorite suggestions)
    const essentialProducts = [
        'Large White Eggs (Dozen)',
        '2% Milk (Lactaid)',
        'Whole Wheat Bread',
        'Russet Potatoes',
        'Yellow Onions',
        'Ground Beef 80/20 (1lb)',
        'Canned Diced Tomatoes',
        'All-Purpose Flour (5lb Bag)',
        'Bottled Water (24-Pack)'
    ];

    const stores = {
      CA: ['Loblaws', 'Sobeys', 'Metro', 'Walmart Canada', 'Costco', 'Real Canadian Superstore', 'No Frills', 'FreshCo', 'Food Basics', 'Safeway', 'Whole Foods Market', 'Nations Fresh Foods', 'Pusateri\'s', 'Longo\'s', 'T&T Supermarket', 'Dollarama'],
      US: ['Walmart', 'Costco', 'Kroger', 'Whole Foods Market', 'Safeway', 'Target', 'Trader Joe\'s', 'Publix', 'Aldi', 'H-E-B', 'Meijer', 'Wegmans', 'Sprouts Farmers Market', 'Food Lion', 'Piggly Wiggly', 'Giant Food', 'The Fresh Market', 'Albertsons', 'Vons'],
      UK: ['Tesco', 'ASDA', 'Sainsbury\'s', 'Morrisons', 'Aldi', 'Lidl']
    };

    const currencies = {
      CA: 'CAD $',
      US: 'USD $',
      UK: 'GBP ¬£'
    };

    // Store color generation
    function getStoreColor(storeName) {
      const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4', '#84cc16', '#f97316', '#ec4899', '#6366f1'];
      let hash = 0;
      for (let i = 0; i < storeName.length; i++) {
        hash = storeName.charCodeAt(i) + ((hash << 5) - hash);
      }
      return colors[Math.abs(hash) % colors.length];
    }

    function getStoreInitials(storeName) {
      return storeName.split(' ').map(word => word.charAt(0).toUpperCase()).slice(0, 2).join('');
    }

    // NEW HELPER: Updates the visual state of the store sort buttons
    function updateSortButtons() {
        // Ensure the container exists before querying
        const container = document.getElementById('storeSortToggleContainer');
        if (!container) return;

        container.querySelectorAll('.sort-option').forEach(btn => {
            if (btn.dataset.sort === storeSortOrder) {
                btn.classList.add('bg-white', 'shadow-sm', 'text-blue-600', 'hover:bg-white');
                btn.classList.remove('text-gray-600', 'hover:bg-gray-200');
            } else {
                btn.classList.remove('bg-white', 'shadow-sm', 'text-blue-600', 'hover:bg-white');
                btn.classList.add('text-gray-600', 'hover:bg-gray-200');
            }
        });
    }

    //==============================================
    // FIREBASE/FIRESTORE IMPLEMENTATION
    //==============================================

    // Firestore implementation for Data SDK
    window.dataSdk = {
        init: async (handler) => {
            try {
                // Initialize Firebase App using the hardcoded user configuration
                const app = initializeApp(FIREBASE_CONFIG);
                
                // Set up Auth and Firestore instances
                auth = getAuth(app);
                db = getFirestore(app);
                // setLogLevel('Debug'); // Enable this for verbose console logging if needed
                
                setAuthButtonState(true); // Initialization successful, enable auth buttons
                initStatusMessageEl.textContent = 'Firebase connected. Checking authentication status...';

                // Set up the authentication state listener
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // USER IS LOGGED IN (Email/Password, Google, or Anonymous)
                        userId = user.uid;
                        isAuthReady = true;
                        
                        // Display user ID on the auth screen (useful for debugging/info)
                        userIdDisplayEl.textContent = `UID: ${userId.substring(0, 8)}...`;
                        
                        // Hide Auth screen, show app screens
                        authScreenEl.classList.remove('active');
                        authScreenEl.style.display = 'none';
                        document.querySelectorAll('.screen').forEach(screen => {
                            if (screen.id !== 'authScreen') screen.classList.remove('active');
                        });
                        document.getElementById('categoriesScreen').classList.add('active');

                        bottomNavEl.style.display = 'flex';
                        signOutBtnEl.style.display = 'block';

                        console.log("User logged in. Starting Firestore listeners.");
                        handler.startListeners(); // Start listening for data immediately

                    } else {
                        // USER IS LOGGED OUT
                        userId = null;
                        isAuthReady = false;
                        userIdDisplayEl.textContent = 'Not Logged In';
                        
                        // Stop all listeners and clear data
                        handler.unsubscribeListeners();
                        allData = [];
                        
                        // Show Auth screen, hide app screens
                        authScreenEl.classList.add('active');
                        authScreenEl.style.display = 'flex';
                        document.querySelectorAll('.screen').forEach(screen => {
                            if (screen.id !== 'authScreen') screen.classList.remove('active');
                        });
                        
                        bottomNavEl.style.display = 'none';
                        signOutBtnEl.style.display = 'none';
                        
                        // Ensure auth mode is set to login for clean start
                        setAuthMode('login'); 
                        
                        console.log("User logged out. App waiting for sign-in.");
                    }
                });

                // Check for initial token if no user state is loaded yet (only on first load)
                if (!auth.currentUser) {
                    try {
                         if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            // Automatically sign in anonymously to initialize a session for security rules
                            await signInAnonymously(auth);
                        }
                    } catch (e) {
                         // Fallback to anonymous sign-in if custom token fails
                         console.warn("Custom token failed, falling back to anonymous:", e);
                         await signInAnonymously(auth);
                    }
                }
                
                return { isOk: true };
                
            } catch (error) {
                console.error("Firebase Initialization Failed:", error);
                setAuthButtonState(false); // Keep buttons disabled on fatal init failure
                showAuthError(`Fatal Init Error: ${error.message}`);
                return { isOk: false, error: error.message };
            }
        },

        startListeners: (handler) => {
             const collectionsToListen = ['product', 'price', 'store', 'list', 'listItem', 'category'];
             
             // First, unsubscribe any existing listeners
             handler.unsubscribeListeners();
             
             collectionsToListen.forEach(collectionName => {
                 // Path: /artifacts/{appId}/users/{userId}/{collectionName}
                 const colRef = collection(db, `artifacts/${APP_ID}/users/${userId}/${collectionName}`);
                 
                 const unsubscribe = onSnapshot(colRef, (snapshot) => {
                     const changes = snapshot.docChanges();
                     let newData = [...allData]; // Start with current data

                     changes.forEach((change) => {
                         const data = { id: change.doc.id, ...change.doc.data() };
                         
                         if (change.type === "added") {
                             if (!newData.some(item => item.id === data.id)) {
                                 newData.push(data);
                             }
                         } else if (change.type === "modified") {
                             const index = newData.findIndex(item => item.id === data.id);
                             if (index !== -1) {
                                 newData[index] = data;
                             }
                         } else if (change.type === "removed") {
                             newData = newData.filter(item => item.id !== data.id);
                         }
                     });
                     
                     handler.onDataChanged(newData);
                 }, (error) => {
                     console.error(`Error listening to collection ${collectionName}:`, error);
                     if (error.code !== 'permission-denied') {
                         showToast(`Failed to sync data for ${collectionName}.`, 'error');
                     }
                 });
                 unsubscribeAll.push(unsubscribe);
             });
        },
        
        unsubscribeListeners: () => {
            unsubscribeAll.forEach(unsubscribe => unsubscribe());
            unsubscribeAll = [];
            console.log("All Firestore listeners unsubscribed.");
        },

        create: async (item) => {
            if (!isAuthReady) {
                 showToast("Please sign in to save data.", 'error');
                 return { isOk: false };
            }
            
            try {
                const itemType = item.type;
                const { type, ...dataToSave } = item; // Destructure `type` out
                
                // CRITICAL: Ensure the path is correctly constructed using APP_ID and userId
                const colRef = collection(db, `artifacts/${APP_ID}/users/${userId}/${itemType}`);
                
                const docRef = await addDoc(colRef, {
                    ...dataToSave,
                    createdAt: new Date().toISOString()
                });
                return { isOk: true, id: docRef.id };
            } catch (e) {
                console.error("Firestore CREATE failed:", e);
                showToast(`Failed to create ${item.type}. Check console for potential security rule or network errors.`, 'error');
                return { isOk: false };
            }
        },

        update: async (updatedItem) => {
            if (!isAuthReady || !updatedItem.id || !updatedItem.type) { 
                 console.error("Firestore UPDATE skipped: Auth not ready or missing ID/Type.");
                 return { isOk: false };
            }
            try {
                const itemType = updatedItem.type;
                const docId = updatedItem.id;
                const { id, type, ...dataToUpdate } = updatedItem; // Destructure `id` and `type` out
                
                const docRef = doc(db, `artifacts/${APP_ID}/users/${userId}/${itemType}`, docId);
                
                await updateDoc(docRef, dataToUpdate);
                return { isOk: true };
            } catch (e) {
                console.error("Firestore UPDATE failed:", e);
                showToast(`Failed to update ${updatedItem.type}. Check console for permissions error.`, 'error');
                return { isOk: false };
            }
        },

        delete: async (itemToDelete) => {
            if (!isAuthReady || !itemToDelete.id || !itemToDelete.type) return { isOk: false };
            try {
                const docRef = doc(db, `artifacts/${APP_ID}/users/${userId}/${itemToDelete.type}`, itemToDelete.id);
                await deleteDoc(docRef);
                return { isOk: true };
            } catch (e) {
                console.error("Firestore DELETE failed:", e);
                showToast(`Failed to delete ${itemToDelete.type}. Check console for permissions error.`, 'error');
                return { isOk: false };
            }
        },
        
        deleteBatch: async (items) => {
            if (!isAuthReady || items.length === 0) return { isOk: true };
            try {
                const batch = writeBatch(db);
                items.forEach(item => {
                    if (item.id && item.type) {
                        const docRef = doc(db, `artifacts/${APP_ID}/users/${userId}/${item.type}`, item.id);
                        batch.delete(docRef);
                    }
                });
                await batch.commit();
                return { isOk: true };
            } catch (e) {
                console.error("Firestore BATCH DELETE failed:", e);
                showToast(`Failed to delete multiple items. Check console for permissions error.`, 'error');
                return { isOk: false };
            }
        }
    };
    
    // Data Handler Object (used by the SDK's onSnapshot listener)
    const dataHandler = {
        onDataChanged(data) {
            allData = data;
            updateFavoriteCount(); 
            updateCurrentView();
        },
        startListeners: () => window.dataSdk.startListeners(dataHandler),
        unsubscribeListeners: () => window.dataSdk.unsubscribeListeners()
    };
    
    // --- AUTHENTICATION LOGIC ---

    // Function to enable/disable auth buttons based on initialization status
    function setAuthButtonState(enabled) {
        authEmailInput.disabled = !enabled;
        authPasswordInput.disabled = !enabled;
        authSubmitBtnEl.disabled = !enabled;
        googleSignInBtnEl.disabled = !enabled;

        if (enabled) {
            authEmailInput.removeAttribute('disabled');
            authPasswordInput.removeAttribute('disabled');
            authSubmitBtnEl.removeAttribute('disabled');
            googleSignInBtnEl.removeAttribute('disabled');
            
            authSubmitBtnEl.classList.remove('bg-indigo-400', 'cursor-not-allowed');
            authSubmitBtnEl.classList.add('bg-indigo-600', 'hover:bg-indigo-700', 'focus:ring-indigo-500');
            googleSignInBtnEl.classList.remove('bg-gray-200', 'cursor-not-allowed');
            googleSignInBtnEl.classList.add('bg-white', 'hover:bg-gray-50', 'focus:ring-indigo-500', 'border-gray-300', 'text-gray-700');
            
            initStatusMessageEl.textContent = 'Ready to sign in or register.';
            initStatusMessageEl.classList.add('text-green-600');
            initStatusMessageEl.classList.remove('text-indigo-500');
        } else {
             authEmailInput.setAttribute('disabled', 'true');
             authPasswordInput.setAttribute('disabled', 'true');
             authSubmitBtnEl.setAttribute('disabled', 'true');
             googleSignInBtnEl.setAttribute('disabled', 'true');
             
             authSubmitBtnEl.classList.add('bg-indigo-400', 'cursor-not-allowed');
             authSubmitBtnEl.classList.remove('bg-indigo-600', 'hover:bg-indigo-700', 'focus:ring-indigo-500');
             googleSignInBtnEl.classList.add('bg-gray-200', 'cursor-not-allowed');
             googleSignInBtnEl.classList.remove('bg-white', 'hover:bg-gray-50', 'focus:ring-indigo-500', 'border-gray-300', 'text-gray-700');
             
             initStatusMessageEl.textContent = 'Initializing Firebase...';
             initStatusMessageEl.classList.remove('text-green-600');
             initStatusMessageEl.classList.add('text-indigo-500');
        }
    }
    
    // Display an error message to the auth form area
    function showAuthError(message) {
        authErrorEl.textContent = message;
        authErrorEl.classList.remove('hidden');
        setTimeout(() => authErrorEl.classList.add('hidden'), 5000);
        console.error(message);
    }
    
    // Auth Mode Toggle
    function setAuthMode(mode) {
        authMode = mode;
        const loginBtn = authModeToggleEl.querySelector('[data-mode="login"]');
        const registerBtn = authModeToggleEl.querySelector('[data-mode="register"]');
        
        // UI Toggle Logic
        if (mode === 'login') {
            loginBtn.classList.add('bg-indigo-600', 'text-white', 'shadow-md');
            loginBtn.classList.remove('text-indigo-700', 'hover:bg-white');
            registerBtn.classList.remove('bg-indigo-600', 'text-white', 'shadow-md');
            registerBtn.classList.add('text-indigo-700', 'hover:bg-white');
            authSubmitBtnEl.textContent = 'Sign In';
        } else {
            registerBtn.classList.add('bg-indigo-600', 'text-white', 'shadow-md');
            registerBtn.classList.remove('text-indigo-700', 'hover:bg-white');
            loginBtn.classList.remove('bg-indigo-600', 'text-white', 'shadow-md');
            loginBtn.classList.add('text-indigo-700', 'hover:bg-white');
            authSubmitBtnEl.textContent = 'Register';
        }
        authErrorEl.classList.add('hidden'); // Clear error when switching mode
    }

    // Handle Email/Password Registration and Login
    async function handleAuthSubmit(event) {
        event.preventDefault();
        authErrorEl.classList.add('hidden');
        
        if (!auth) {
            showAuthError("Authentication system is not ready.");
            return;
        }

        const email = authEmailInput.value.trim();
        const password = authPasswordInput.value;

        if (password.length < 6) {
            showAuthError("Password must be at least 6 characters.");
            return;
        }

        try {
            if (authMode === 'register') {
                await createUserWithEmailAndPassword(auth, email, password);
                showToast("Registration successful! Signed in automatically.");
            } else { // 'login'
                await signInWithEmailAndPassword(auth, email, password);
            }
        } catch (error) {
            let errorMessage = "An unknown authentication error occurred.";
            switch (error.code) {
                case 'auth/invalid-email':
                    errorMessage = 'Invalid email format.';
                    break;
                case 'auth/user-not-found':
                case 'auth/wrong-password':
                    errorMessage = 'Invalid email or password.';
                    break;
                case 'auth/email-already-in-use':
                    errorMessage = 'This email is already registered. Try signing in.';
                    break;
                case 'auth/weak-password':
                    errorMessage = 'Password is too weak. Must be at least 6 characters.';
                    break;
                default:
                    errorMessage = error.message;
                    break;
            }
            showAuthError(errorMessage);
        }
    }

    // Handle Google Sign-In
    async function handleGoogleSignIn() {
        authErrorEl.classList.add('hidden');
        
        if (!auth) {
            showAuthError("Authentication system is not ready.");
            return;
        }

        try {
            const provider = new GoogleAuthProvider();
            await signInWithPopup(auth, provider);
        } catch (error) {
            let errorMessage = "Google Sign-In Failed.";
            
            if (error.code) {
                if (error.code === 'auth/popup-closed-by-user') {
                    errorMessage = 'Sign-in window closed. Please try again.';
                } else if (error.code === 'auth/cancelled-popup-request') {
                    errorMessage = 'Sign-in cancelled. Did you already have a pop-up open?';
                } else if (error.code === 'auth/account-exists-with-different-credential') {
                    errorMessage = 'An account already exists with this email using a different login method.';
                } else {
                    errorMessage = `Error: ${error.code}`;
                }
            } else {
                errorMessage = error.message;
            }

            showAuthError(errorMessage);
        }
    }

    // Sign Out Handler
    async function handleSignOut() {
        if (auth) {
            try {
                await signOut(auth);
                showToast('Signed out successfully.');
            } catch (error) {
                showToast(`Sign out failed: ${error.message}`, 'error');
            }
        }
    }


    // --- UI Setup Helper ---
    function setupStoreSortUI() {
        const storesScreen = document.getElementById('storesScreen');
        // Create the new segmented control container
        const storeSortToggleContainer = document.createElement('div');
        storeSortToggleContainer.id = 'storeSortToggleContainer';
        storeSortToggleContainer.className = 'search-bar'; // Reuse search-bar styling for padding/spacing
        storeSortToggleContainer.innerHTML = `
            <div class="inline-flex rounded-lg bg-gray-100 p-1 text-sm border border-gray-200 mx-auto" style="flex: 1; max-width: 300px;">
                <button class="sort-option w-1/2 px-3 py-1 rounded-md font-medium transition-all duration-200" data-sort="name">Name (A-Z)</button>
                <button class="sort-option w-1/2 px-3 py-1 rounded-md font-medium transition-all duration-200" data-sort="cheapest">Cheapest</button>
            </div>
        `;
        // Prepend it *after* the initial search bar and add button
        const storeGrid = document.getElementById('storeGrid');
        if (storesScreen && storeGrid) {
            storesScreen.insertBefore(storeSortToggleContainer, storeGrid);
        }
    }


    // Initialize app
    async function initApp() {
      // 1. Setup static UI elements (like the store sort buttons)
      setupStoreSortUI();
      
      // 2. Setup event listeners
      setupEventListeners();
      
      // 3. Apply initial configuration styles
      applyConfig(defaultConfig);
      
      // 4. Initialize Data SDK (Firebase connection and listener)
      const initResult = await window.dataSdk.init(dataHandler); 
      if (!initResult.isOk) {
        showAuthError(`Initialization Failed: ${initResult.error}`);
        authScreenEl.classList.add('active');
        authScreenEl.style.display = 'flex';
        document.getElementById('categoriesScreen').classList.remove('active');
      } else {
        // If init is OK, onAuthStateChanged will handle the rest
        authScreenEl.classList.add('active'); // Start on auth screen
        authScreenEl.style.display = 'flex';
      }
      
      // 5. Initial screen setting is handled by onAuthStateChanged now.
    }

    // This function replaces the original onConfigChange
    function applyConfig(config) {
      const headerTitle = document.getElementById('headerTitle');
      const headerSubtitle = document.getElementById('headerSubtitle');
      const header = document.querySelector('.header');
      const primaryButtons = document.querySelectorAll('.btn-primary');
      const secondaryButtons = document.querySelectorAll('.btn-secondary, .search-add-btn');
      const accentButtons = document.querySelectorAll('.btn-accent');

      if (headerTitle) headerTitle.textContent = config.app_title || defaultConfig.app_title;
      if (headerSubtitle) headerSubtitle.textContent = config.welcome_message || defaultConfig.welcome_message;

      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const secondaryColor = config.secondary_color || defaultConfig.secondary_color;
      const accentColor = config.accent_color || defaultConfig.accent_color;

      if (header) header.style.background = primaryColor;
      primaryButtons.forEach(btn => {
        btn.style.background = primaryColor;
      });
      secondaryButtons.forEach(btn => {
        btn.style.background = secondaryColor;
      });
      accentButtons.forEach(btn => {
        btn.style.background = accentColor;
      });

      // Update active nav item color
      const activeNavItem = document.querySelector('.nav-item.active');
      if (activeNavItem) activeNavItem.style.color = primaryColor;

      // Update toggle switch color
      const toggleSwitch = document.querySelector('.toggle-switch.active');
      if (toggleSwitch) toggleSwitch.style.background = primaryColor;
    }

    // NEW: Updates the favorite count in the settings menu
    function updateFavoriteCount() {
        const favoriteCountElement = document.getElementById('favoriteCount');
        if (!favoriteCountElement) return;

        const favoriteCount = allData.filter(item => item.type === 'product' && item.isFavorite).length;
        favoriteCountElement.textContent = `${favoriteCount} item${favoriteCount !== 1 ? 's' : ''}`;
    }


    // Event listeners
    function setupEventListeners() {
      // Navigation
      document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', () => {
          if (!userId) {
              showToast("Please sign in to view app sections.", 'error');
              return;
          }
          const screen = item.dataset.screen;
          if (screen) {
            currentCategory = '';
            currentStore = '';
            currentList = '';
            currentProduct = '';
            // Clear all search inputs on screen change
            document.getElementById('categorySearch').value = '';
            document.getElementById('productSearch').value = '';
            document.getElementById('storeSearch').value = '';
            document.getElementById('listProductSearch').value = '';
            document.getElementById('searchResults').style.display = 'none'; // Hide search results
            document.getElementById('listSearchResults').style.display = 'none';
            document.getElementById('categoryGrid').style.display = 'grid'; // Show category grid

            // Clear store price search if present
            const storeProductSearch = document.getElementById('storeProductSearch');
            if (storeProductSearch) storeProductSearch.value = '';
            const storePriceSearchResults = document.getElementById('storePriceSearchResults');
            if (storePriceSearchResults) storePriceSearchResults.style.display = 'none';
            
            // NEW: Clear favorites search when navigating away
            const favoriteProductSearch = document.getElementById('favoriteProductSearch');
            if (favoriteProductSearch) favoriteProductSearch.value = '';
            
            switchScreen(screen);
          }
        });
      });

      // Back button
      document.getElementById('backBtn').addEventListener('click', goBack);

      // Country selection
      document.getElementById('countryFlag').addEventListener('click', (e) => {
        e.stopPropagation();
        const dropdown = document.getElementById('countryDropdown');
        dropdown.classList.toggle('active');
      });

      document.querySelectorAll('.country-option').forEach(option => {
        option.addEventListener('click', () => {
          currentRegion = option.dataset.region;
          updateCountryFlag();
          document.getElementById('countryDropdown').classList.remove('active');
          renderStores();
        });
      });

      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (!e.target.closest('#countrySelector')) {
          document.getElementById('countryDropdown').classList.remove('active');
        }
      });

      // Search inputs
      document.getElementById('categorySearch').addEventListener('input', (e) => {
        performGlobalSearch(e.target.value);
      });

      document.getElementById('productSearch').addEventListener('input', (e) => {
        // Now calling a function that performs the cross-category search logic even from the products screen
        performProductSearch(e.target.value);
      });

      document.getElementById('storeSearch').addEventListener('input', (e) => {
        filterStores(e.target.value);
      });
      
      // NEW: Store Price Search Listener
      const storeProductSearch = document.getElementById('storeProductSearch');
      if (storeProductSearch) {
          storeProductSearch.addEventListener('input', (e) => {
              searchProductsForStorePrice(e.target.value);
          });
      }


      document.getElementById('listProductSearch').addEventListener('input', (e) => {
        searchProductsForList(e.target.value);
      });
      
      // NEW: Favorite Product Search Listener
      const favoriteProductSearch = document.getElementById('favoriteProductSearch');
      if (favoriteProductSearch) {
          favoriteProductSearch.addEventListener('input', (e) => {
              searchProductsForFavorites(e.target.value);
          });
      }
      
      // --- Store Sort Toggle Event Listeners ---
      document.addEventListener('click', (e) => {
          if (e.target.closest('#storeSortToggleContainer .sort-option')) {
              const target = e.target.closest('[data-sort]');
              if (target) {
                  storeSortOrder = target.dataset.sort;
                  updateSortButtons();
                  renderStores();
              }
          }
      });

      // Initial visual update (must be called after elements are created)
      updateSortButtons();
      // --- END Store Sort Toggle Event Listeners ---

      // Add buttons
      document.getElementById('addProductBtn').addEventListener('click', () => {
        openModal('addProductModal');
        populateProductCategories();
      });

      document.getElementById('addStoreBtn').addEventListener('click', () => {
        openModal('addStoreModal');
      });

      document.getElementById('addListBtn').addEventListener('click', () => {
        openModal('addListModal');
      });

      document.getElementById('addCategoryBtn').addEventListener('click', () => {
        openModal('addCategoryModal');
      });

      document.getElementById('addPriceBtn').addEventListener('click', () => {
        openPriceModal(currentProduct);
      });

      // Quick Add button
      document.getElementById('quickAddBtn').addEventListener('click', openQuickAddModal);

      // Save/Update/Delete buttons
      document.getElementById('savePriceBtn').addEventListener('click', savePrice);
      document.getElementById('updatePriceBtn').addEventListener('click', updatePrice); // New
      document.getElementById('deletePriceBtn').addEventListener('click', deletePrice); // New

      document.getElementById('saveProductBtn').addEventListener('click', saveProduct);
      document.getElementById('saveStoreBtn').addEventListener('click', saveStore);
      document.getElementById('saveListBtn').addEventListener('click', saveList);
      document.getElementById('saveUnitBtn').addEventListener('click', saveUnit);
      document.getElementById('saveCountryBtn').addEventListener('click', saveCountry);
      document.getElementById('saveQuickAddBtn').addEventListener('click', saveQuickAdd);
      document.getElementById('saveCategoryBtn').addEventListener('click', saveCategory);
      document.getElementById('updateProductBtn').addEventListener('click', updateProduct);
      document.getElementById('updateListBtn').addEventListener('click', updateList);
      document.getElementById('confirmDeleteBtn').addEventListener('click', confirmDelete);
      document.getElementById('confirmDeleteListBtn').addEventListener('click', confirmDeleteList);
      document.getElementById('updateStoreBtn').addEventListener('click', updateStore); // New

      // Modal buttons
      document.getElementById('createNewListBtn').addEventListener('click', () => {
        document.getElementById('newListGroup').style.display = 'block';
        document.getElementById('existingListGroup').style.display = 'none';
      });

      document.getElementById('addToExistingBtn').addEventListener('click', () => {
        document.getElementById('existingListGroup').style.display = 'block';
        document.getElementById('newListGroup').style.display = 'none';
        populateExistingLists();
      });

      document.getElementById('confirmAddToListBtn').addEventListener('click', confirmAddToList);

      // Price calculation
      document.getElementById('priceAmount').addEventListener('input', calculatePPU);
      document.getElementById('priceQuantity').addEventListener('input', calculatePPU);
      document.getElementById('priceUnit').addEventListener('change', calculatePPU);

      document.getElementById('editPriceAmount').addEventListener('input', calculateEditPPU); // New
      document.getElementById('editPriceQuantity').addEventListener('input', calculateEditPPU); // New
      document.getElementById('editPriceUnit').addEventListener('change', calculateEditPPU); // New

      // Quick add calculation and suggestions
      document.getElementById('quickPrice').addEventListener('input', calculateQuickPPU);
      document.getElementById('quickQuantity').addEventListener('input', calculateQuickPPU);
      document.getElementById('quickUnit').addEventListener('change', calculateQuickPPU);
      document.getElementById('quickProductName').addEventListener('input', showProductSuggestions);

      // Group toggle
      document.getElementById('groupToggle').addEventListener('click', toggleGrouping);

      // Settings
      document.getElementById('countrySetting').addEventListener('click', () => {
        openModal('countryModal');
        document.getElementById('countrySelect').value = currentRegion;
      });

      document.getElementById('unitSetting').addEventListener('click', () => {
        openModal('unitModal');
        document.getElementById('unitSelect').value = currentUnit;
      });
      
      // NEW: Favorites Setting Link
      document.getElementById('favoritesSetting').addEventListener('click', () => {
        showSubScreen('favoritesScreen', 'Your Favorites');
        renderFavorites();
      });
      
      // --- AUTH EVENT LISTENERS ---
      signOutBtnEl.addEventListener('click', handleSignOut);
      authFormEl.addEventListener('submit', handleAuthSubmit);
      googleSignInBtnEl.addEventListener('click', handleGoogleSignIn);
      
      authModeToggleEl.addEventListener('click', (e) => {
          const button = e.target.closest('button');
          if (button) {
              setAuthMode(button.getAttribute('data-mode'));
          }
      });
    }

    // Screen management
    function switchScreen(screenName) {
      document.querySelectorAll('.screen').forEach(screen => {
          if (screen.id !== 'authScreen') screen.classList.remove('active');
      });
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });

      document.getElementById(screenName + 'Screen').classList.add('active');
      const navItem = document.querySelector(`[data-screen="${screenName}"]`);
      if (navItem) navItem.classList.add('active');
      currentScreen = screenName;
      updateHeader();
      updateCurrentView();
    }

    function showSubScreen(screenId, title, showBack = true) {
      document.querySelectorAll('.screen').forEach(screen => {
          if (screen.id !== 'authScreen') screen.classList.remove('active');
      });
      document.getElementById(screenId).classList.add('active');
      document.getElementById('headerTitle').textContent = title;
      document.getElementById('backBtn').style.display = showBack ? 'block' : 'none';
    }

    function goBack() {
      if (currentScreen === 'favorites') { // Handle specific back from favorites screen
        switchScreen('settings');
        return;
      }
      
      if (currentProduct) {
        currentProduct = '';
        if (currentCategory) {
          showSubScreen('productsScreen', currentCategory);
          renderProducts();
        } else {
          switchScreen('categories');
        }
      } else if (currentCategory) {
        currentCategory = '';
        switchScreen('categories');
      } else if (currentStore) {
        currentStore = '';
        // Clear search state when returning from detail view to main store view
        const searchInput = document.getElementById('storeProductSearch');
        if (searchInput) searchInput.value = '';
        switchScreen('stores');
      } else if (currentList) {
        currentList = '';
        switchScreen('lists');
      } else if (currentScreen === 'settings') {
        switchScreen('categories'); // Default back from settings
      }
    }

    function updateHeader() {
      const config = defaultConfig; // Use our hardcoded config
      if (currentProduct) {
        document.getElementById('headerTitle').textContent = currentProduct;
        document.getElementById('headerSubtitle').textContent = 'Price details';
        document.getElementById('backBtn').style.display = 'block';
      } else if (currentCategory) {
        document.getElementById('headerTitle').textContent = currentCategory;
        document.getElementById('headerSubtitle').textContent = 'Select a product';
        document.getElementById('backBtn').style.display = 'block';
      } else if (currentStore) {
        document.getElementById('headerTitle').textContent = currentStore;
        document.getElementById('headerSubtitle').textContent = 'Products with prices';
        document.getElementById('backBtn').style.display = 'block';
      } else if (currentList) {
        document.getElementById('headerTitle').textContent = currentList;
        document.getElementById('headerSubtitle').textContent = 'Shopping list items';
        document.getElementById('backBtn').style.display = 'block';
      } else if (currentScreen === 'favorites') {
        document.getElementById('headerTitle').textContent = 'Your Favorites';
        document.getElementById('headerSubtitle').textContent = 'Easily access your top items';
        document.getElementById('backBtn').style.display = 'block';
      } else {
        document.getElementById('headerTitle').textContent = config.app_title || defaultConfig.app_title;
        document.getElementById('headerSubtitle').textContent = config.welcome_message || defaultConfig.welcome_message;
        document.getElementById('backBtn').style.display = 'none';
      }
    }

    // Rendering functions
    function renderCategories() {
      const grid = document.getElementById('categoryGrid');
      grid.innerHTML = '';

      // Render predefined categories
      Object.entries(categories).forEach(([name, data]) => {
        const card = document.createElement('div');
        card.className = 'category-card';
        card.innerHTML = `<div class="category-icon">${data.icon}</div><div class="category-name">${name}</div>`;
        card.addEventListener('click', () => {
          currentCategory = name;
          showSubScreen('productsScreen', name);
          renderProducts();
        });
        grid.appendChild(card);
      });

      // Render custom categories
      const customCategories = allData.filter(item => item.type === 'category');
      customCategories.forEach(category => {
        const card = document.createElement('div');
        card.className = 'category-card';
        card.innerHTML = `<div class="category-icon">${category.icon}</div><div class="category-name">${category.name}</div>`;
        card.addEventListener('click', () => {
          currentCategory = category.name;
          showSubScreen('productsScreen', category.name);
          renderProducts();
        });
        grid.appendChild(card);
      });
    }
    
    // NEW: Render Favorites Screen
    function renderFavorites() {
        const favoritesGrid = document.getElementById('favoritesList');
        const searchInput = document.getElementById('favoriteProductSearch');
        const searchResults = document.getElementById('favoriteSearchResults');

        favoritesGrid.innerHTML = '';
        searchResults.innerHTML = '';
        
        // Check if search is active
        if (searchInput && searchInput.value.trim() !== '') {
            searchProductsForFavorites(searchInput.value.trim());
            return;
        }

        searchResults.style.display = 'none';
        favoritesGrid.style.display = 'grid';

        // Display the main favorites list
        const allProductNames = getAllProductNames();
        const favoriteProducts = [];
        
        allProductNames.forEach(productName => {
            const customRecord = getCustomProductRecord(productName);
            if (customRecord && customRecord.isFavorite) {
                favoriteProducts.push(productName);
            }
        });
        
        // Show empty state if no favorites and no search is active
        if (favoriteProducts.length === 0) {
            // Use an empty element to occupy the space and apply padding/centering
            favoritesGrid.innerHTML = `<div class="empty-state w-full col-span-4"><div class="empty-icon">‚≠ê</div><p>No favorites yet!</p><p style="font-size: 0.8rem;">Use the search bar above to quickly add an item.</p></div>`;
            return;
        }

        // Render favorites list items (4-column grid items)
        favoriteProducts.forEach(productName => {
            const prices = allData.filter(item => item.type === 'price' && item.name === productName);
            const cheapestPrice = getCheapestPrice(prices);
            let productIcon = getProductIcon(productName);
            
            const customProduct = getCustomProductRecord(productName);
            const brand = customProduct?.brand || '';
            const tags = customProduct?.tags ? customProduct.tags.split(',').map(t => t.trim()) : [];
            const category = getProductCategory(productName);
            const isFavorite = customProduct?.isFavorite || false;
            
            // Use product-item structure for rich detail
            const item = document.createElement('div');
            item.className = 'product-item'; 
            item.innerHTML = `
                <button class="action-btn favorite" 
                        onclick="event.stopPropagation(); window.toggleFavorite('${productName.replace(/'/g, "\\'")}')">
                    ${isFavorite ? '‚òÖ' : '‚òÜ'}
                </button>
                <div class="product-actions">
                    <button class="action-btn add" onclick="event.stopPropagation(); window.openAddToListModal('${productName.replace(/'/g, "\\'")}')">+</button>
                    <button class="action-btn duplicate" onclick="event.stopPropagation(); window.duplicateProduct('${productName.replace(/'/g, "\\'")}')">‚ßâ</button>
                    ${customProduct ? `<button class="action-btn edit" onclick="event.stopPropagation(); window.editProduct('${productName.replace(/'/g, "\\'")}')">‚úé</button>` : ''}
                    ${customProduct ? `<button class="action-btn delete" onclick="event.stopPropagation(); window.deleteProduct('${productName.replace(/'/g, "\\'")}')">‚úï</button>` : ''}
                </div>
                <div class="product-icon">${productIcon}</div>
                <div class="product-info">
                    <h3>${productName}</h3>
                    ${brand ? `<div class="product-brand">by ${brand}</div>` : ''}
                    <div class="product-meta">${prices.length} price${prices.length !== 1 ? 's' : ''} - ${category}</div>
                    ${tags.length > 0 ? `<div class="product-tags">${tags.map(tag => `<span class="tag">${tag}</span>`).join('')}</div>` : ''}
                </div>
                <div class="price-info">
                    ${cheapestPrice ? `<div class="price">${currencies[currentRegion]}${cheapestPrice.price.toFixed(2)}</div><div class="ppu">${currencies[currentRegion]}${(cheapestPrice.price / cheapestPrice.quantity).toFixed(2)}/${cheapestPrice.unit}</div>` : `<div class="price">No price</div>`}
                </div>
                `;
            item.addEventListener('click', (e) => {
                if (!e.target.closest('.action-btn')) {
                    showProductDetail(productName);
                }
            });
            favoritesGrid.appendChild(item);
        });
    }

    // New function to handle product search on the product screen (cross-category)
    function performProductSearch(query) {
        const list = document.getElementById('productList');
        const lowerQuery = query.toLowerCase();

        // 1. Get all unique product names
        const allProductNames = getAllProductNames();

        // 2. Filter products based on search query
        const matchingProductNames = allProductNames.filter(productName => {
            const prices = allData.filter(item => item.type === 'price' && item.name === productName);
            const customProduct = allData.find(item => item.type === 'product' && item.name === productName);
            
            // Collect all searchable text
            let searchText = productName.toLowerCase();
            if (customProduct) {
                searchText += ` ${customProduct.brand?.toLowerCase() || ''}`;
                searchText += ` ${customProduct.tags?.toLowerCase() || ''}`;
            }
            if (prices.length > 0) {
                searchText += ` ${prices.map(p => p.store.toLowerCase()).join(' ')}`;
            }

            return searchText.includes(lowerQuery);
        });

        // 3. Clear and re-render only the matched products
        list.innerHTML = '';

        if (matchingProductNames.length === 0) {
            list.innerHTML = `<div class="empty-state"><div class="empty-icon">üîç</div><p>No products found for "${query}"</p></div>`;
            return;
        }

        matchingProductNames.forEach(productName => {
            const prices = allData.filter(item => item.type === 'price' && item.name === productName);
            const cheapestPrice = getCheapestPrice(prices);
            let productIcon = getProductIcon(productName);
            
            const customProduct = allData.find(item => item.type === 'product' && item.name === productName);
            const brand = customProduct?.brand || '';
            const tags = customProduct?.tags ? customProduct.tags.split(',').map(t => t.trim()) : [];
            const category = getProductCategory(productName); // Ensure category is available
            
            const isFavorite = customProduct?.isFavorite || false;

            const item = document.createElement('div');
            item.className = 'product-item';
            item.innerHTML = `
                <button class="action-btn favorite" onclick="event.stopPropagation(); window.toggleFavorite('${productName.replace(/'/g, "\\'")}')">
                    ${isFavorite ? '‚òÖ' : '‚òÜ'}
                </button>
                <div class="product-actions">
                    <button class="action-btn add" onclick="event.stopPropagation(); window.openAddToListModal('${productName.replace(/'/g, "\\'")}')">+</button>
                    <button class="action-btn duplicate" onclick="event.stopPropagation(); window.duplicateProduct('${productName.replace(/'/g, "\\'")}')">‚ßâ</button>
                    ${customProduct ? `<button class="action-btn edit" onclick="event.stopPropagation(); window.editProduct('${productName.replace(/'/g, "\\'")}')">‚úé</button>` : ''}
                    ${customProduct ? `<button class="action-btn delete" onclick="event.stopPropagation(); window.deleteProduct('${productName.replace(/'/g, "\\'")}')">‚úï</button>` : ''}
                </div>
                <div class="product-icon">${productIcon}</div>
                <div class="product-info">
                    <h3>${productName}</h3>
                    ${brand ? `<div class="product-brand">by ${brand}</div>` : ''}
                    <div class="product-meta">${prices.length} price${prices.length !== 1 ? 's' : ''} - ${category}</div>
                    ${tags.length > 0 ? `<div class="product-tags">${tags.map(tag => `<span class="tag">${tag}</span>`).join('')}</div>` : ''}
                </div>
                <div class="price-info">
                    ${cheapestPrice ? `<div class="price">${currencies[currentRegion]}${cheapestPrice.price.toFixed(2)}</div><div class="ppu">${currencies[currentRegion]}${(cheapestPrice.price / cheapestPrice.quantity).toFixed(2)}/${cheapestPrice.unit}</div>` : `<div class="price">No price</div>`}
                </div>`;
            item.addEventListener('click', (e) => {
                if (!e.target.closest('.action-btn')) {
                    showProductDetail(productName);
                }
            });
            list.appendChild(item);
        });
    }
    
    function renderProducts() {
      const list = document.getElementById('productList');
      list.innerHTML = '';
      
      const productSearchInput = document.getElementById('productSearch');
      if (productSearchInput.value.trim() !== '') {
          // If a search is active, show the search results instead of the full category list
          performProductSearch(productSearchInput.value.trim());
          return;
      }
      
      let products = [];
      if (currentCategory && categories[currentCategory]) {
        products = categories[currentCategory].products;
      }

      // Add custom products for this category
      const customProducts = allData.filter(item => item.type === 'product' && item.category === currentCategory);
      // Also check for custom categories
      const customCategory = allData.find(item => item.type === 'category' && item.name === currentCategory);
      if (customCategory) {
        const customCategoryProducts = allData.filter(item => item.type === 'product' && item.category === currentCategory);
        products = [...customCategoryProducts.map(p => p.name)];
      } else {
        products = [...products, ...customProducts.map(p => p.name)];
      }
      
      // Ensure unique names
      products = [...new Set(products)];

      if (products.length === 0) {
        list.innerHTML = `<div class="empty-state"><div class="empty-icon">üì¶</div><p>No products found</p></div>`;
        return;
      }

      products.forEach(productName => {
        const prices = allData.filter(item => item.type === 'price' && item.name === productName);
        const cheapestPrice = getCheapestPrice(prices);
        // Get icon from custom product or predefined mapping
        let productIcon = getProductIcon(productName);

        // Get brand and tags from custom product with matching name AND brand
        const customProduct = allData.find(item => item.type === 'product' && item.name === productName);
        const brand = customProduct?.brand || '';
        const tags = customProduct?.tags ? customProduct.tags.split(',').map(t => t.trim()) : [];
        
        const isFavorite = customProduct?.isFavorite || false;

        const item = document.createElement('div');
        item.className = 'product-item';
        item.innerHTML = `
          <button class="action-btn favorite" onclick="event.stopPropagation(); window.toggleFavorite('${productName.replace(/'/g, "\\'")}')">
              ${isFavorite ? '‚òÖ' : '‚òÜ'}
          </button>
          <div class="product-actions">
            <button class="action-btn add" onclick="event.stopPropagation(); window.openAddToListModal('${productName.replace(/'/g, "\\'")}')">+</button>
            <button class="action-btn duplicate" onclick="event.stopPropagation(); window.duplicateProduct('${productName.replace(/'/g, "\\'")}')">‚ßâ</button>
            <button class="action-btn edit" onclick="event.stopPropagation(); window.editProduct('${productName.replace(/'/g, "\\'")}')">‚úé</button>
            ${customProduct ? `<button class="action-btn delete" onclick="event.stopPropagation(); window.deleteProduct('${productName.replace(/'/g, "\\'")}')">‚úï</button>` : ''}
          </div>
          <div class="product-icon">${productIcon}</div>
          <div class="product-info">
            <h3>${productName}</h3>
            ${brand ? `<div class="product-brand">by ${brand}</div>` : ''}
            <div class="product-meta">${prices.length} price${prices.length !== 1 ? 's' : ''}</div>
            ${tags.length > 0 ? `<div class="product-tags">${tags.map(tag => `<span class="tag">${tag}</span>`).join('')}</div>` : ''}
          </div>
          <div class="price-info">
            ${cheapestPrice ? `<div class="price">${currencies[currentRegion]}${cheapestPrice.price.toFixed(2)}</div><div class="ppu">${currencies[currentRegion]}${(cheapestPrice.price / cheapestPrice.quantity).toFixed(2)}/${cheapestPrice.unit}</div>` : `<div class="price">No price</div>`}
          </div>`;
        item.addEventListener('click', (e) => {
          if (!e.target.closest('.action-btn')) {
            showProductDetail(productName);
          }
        });
        list.appendChild(item);
      });
    }

    function renderStores() {
      // Ensure visual state of buttons is correct when rendering
      updateSortButtons();
      
      const grid = document.getElementById('storeGrid');
      grid.innerHTML = '';

      let storeList = [...stores[currentRegion]];
      // Add custom stores
      const customStores = allData.filter(item => item.type === 'store' && item.region === currentRegion);
      storeList = [...storeList, ...customStores.map(s => s.name)];
      
      // Calculate cheapest item count for sorting
      const storeCheapestCount = {};
      const allPrices = allData.filter(item => item.type === 'price' && item.region === currentRegion);
      const uniqueProductNames = [...new Set(allPrices.map(p => p.name))];
      
      uniqueProductNames.forEach(productName => {
        const pricesForProduct = allPrices.filter(p => p.name === productName);
        const cheapestPrice = getCheapestPrice(pricesForProduct);
        if (cheapestPrice) {
          storeCheapestCount[cheapestPrice.store] = (storeCheapestCount[cheapestPrice.store] || 0) + 1;
        }
      });
      
      // Filter out duplicate store names
      storeList = [...new Set(storeList)];

      // Apply sorting logic
      if (storeSortOrder === 'name') {
          storeList.sort((a, b) => a.localeCompare(b));
      } else if (storeSortOrder === 'cheapest') {
          storeList.sort((a, b) => {
              const countA = storeCheapestCount[a] || 0;
              const countB = storeCheapestCount[b] || 0;
              return countB - countA; // Descending order
          });
      }

      storeList.forEach(storeName => {
        const priceCount = allData.filter(item => item.type === 'price' && item.store === storeName).length;
        const initials = getStoreInitials(storeName);
        const color = getStoreColor(storeName);
        
        // Check if it's a custom store for action buttons
        const isCustomStore = customStores.some(s => s.name === storeName);
        
        const cheapestCount = storeCheapestCount[storeName] || 0;
        
        const card = document.createElement('div');
        card.className = 'store-card';
        card.innerHTML = `
          <div class="product-actions" style="opacity: 1; top: 0.5rem; right: 0.5rem;">
            ${isCustomStore ? `<button class="action-btn delete" onclick="event.stopPropagation(); window.deleteStore('${storeName.replace(/'/g, "\\'")}')">‚úï</button>` : ''}
            <button class="action-btn duplicate" onclick="event.stopPropagation(); window.duplicateStore('${storeName.replace(/'/g, "\\'")}')">‚ßâ</button>
            ${isCustomStore ? `<button class="action-btn edit" onclick="event.stopPropagation(); window.openEditStoreModal('${storeName.replace(/'/g, "\\'")}')">‚úé</button>` : ''}
          </div>
          <div class="store-initials" style="background-color: ${color}">${initials}</div>
          <div class="store-name">${storeName}</div>
          <div class="store-count">${priceCount} product${priceCount !== 1 ? 's' : ''}</div>
          <div class="product-meta" style="font-size: 0.6rem; margin-top: 0.2rem; color: ${cheapestCount > 0 ? '#059669' : '#64748b'}; font-weight: 600;">
            ${cheapestCount} cheapest item${cheapestCount !== 1 ? 's' : ''}
          </div>
          `;
        card.addEventListener('click', () => {
          currentStore = storeName;
          showSubScreen('storeDetailScreen', storeName);
          renderStoreProducts();
        });
        grid.appendChild(card);
      });
    }

    function renderStoreProducts() {
      const list = document.getElementById('storeProductList');
      const searchResults = document.getElementById('storePriceSearchResults');
      const searchInput = document.getElementById('storeProductSearch');

      // Default state: show list, hide search results
      list.style.display = 'block';
      searchResults.style.display = 'none';

      if (searchInput && searchInput.value.trim() !== '') {
          // If search is active, don't re-render the list, let searchProductsForStorePrice handle rendering
          return;
      }
      
      list.innerHTML = '';

      const prices = allData.filter(item => item.type === 'price' && item.store === currentStore);

      if (prices.length === 0) {
        list.innerHTML = `<div class="empty-state"><div class="empty-icon">üè™</div><p>No prices tracked for this store</p><p style="font-size: 0.8rem;">Use the search bar above to add a price record.</p></div>`;
        return;
      }
      
      // Group prices by product name to find the latest for display
      const productsInStore = {};
      prices.forEach(price => {
          if (!productsInStore[price.name] || new Date(price.createdAt) > new Date(productsInStore[price.name].createdAt)) {
              productsInStore[price.name] = price;
          }
      });
      
      Object.values(productsInStore).forEach(price => {
        // Get brand and tags from custom product
        const customProduct = allData.find(item => item.type === 'product' && item.name === price.name);
        const brand = customProduct?.brand || '';
        const tags = customProduct?.tags ? customProduct.tags.split(',').map(t => t.trim()) : [];
        const item = document.createElement('div');
        item.className = 'product-item list-style';
        item.innerHTML = `
          <div class="product-info">
            <h3>${price.name}</h3>
            ${brand ? `<div class="product-brand">by ${brand}</div>` : ''}
            <div class="product-meta">${price.category}</div>
            ${tags.length > 0 ? `<div class="product-tags">${tags.map(tag => `<span class="tag">${tag}</span>`).join('')}</div>` : ''}
          </div>
          <div class="price-info">
            <div class="price">${currencies[currentRegion]}${price.price.toFixed(2)}</div>
            <div class="ppu">${currencies[currentRegion]}${(price.price / price.quantity).toFixed(2)}/${price.unit}</div>
          </div>`;
        list.appendChild(item);
      });
    }

    // NEW: Search function for adding prices inside the Store Detail screen
    function searchProductsForStorePrice(query) {
        const searchResults = document.getElementById('storePriceSearchResults');
        const productListContainer = document.getElementById('storeProductList');
        const storeName = currentStore;

        if (!query.trim()) {
            searchResults.style.display = 'none';
            productListContainer.style.display = 'block';
            renderStoreProducts(); // Refresh original list
            return;
        }

        searchResults.style.display = 'block';
        productListContainer.style.display = 'none';
        searchResults.innerHTML = '';

        const lowerQuery = query.toLowerCase();
        let hasResults = false;

        // Search all products (predefined and custom)
        const allProductNames = getAllProductNames();
        const productMap = {}; 

        allProductNames.forEach(productName => {
            const customProduct = getCustomProductRecord(productName);
            const category = getProductCategory(productName);
            
            let searchText = productName.toLowerCase();
            if (customProduct) {
                searchText += ` ${customProduct.brand?.toLowerCase() || ''}`;
                searchText += ` ${customProduct.tags?.toLowerCase() || ''}`;
            }
            
            if (searchText.includes(lowerQuery)) {
                productMap[productName] = { 
                    name: productName, 
                    category: category, 
                    customProduct: customProduct 
                };
            }
        });
        
        const matchingProducts = Object.values(productMap);

        if (matchingProducts.length > 0) {
            hasResults = true;
            matchingProducts.forEach(product => {
                const productIcon = getProductIcon(product.name);
                const brand = product.customProduct?.brand || '';
                const tags = product.customProduct?.tags ? product.customProduct.tags.split(',').map(t => t.trim()) : [];
                
                // Find the most recent price for THIS store
                const latestPrice = allData.filter(item => item.type === 'price' && item.name === product.name && item.store === storeName)
                                           .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))[0];

                const item = document.createElement('div');
                item.className = 'product-item list-style';
                item.style.cursor = 'pointer';
                item.innerHTML = `
                    <div class="product-icon" style="font-size: 1.2rem; margin-right: 0.5rem;">${productIcon}</div>
                    <div class="product-info">
                        <h3>${product.name}</h3>
                        ${brand ? `<div class="product-brand">by ${brand}</div>` : ''}
                        <div class="product-meta">${product.category}</div>
                        ${tags.length > 0 ? `<div class="product-tags">${tags.map(tag => `<span class="tag">${tag}</span>`).join('')}</div>` : ''}
                    </div>
                    <div class="price-info" style="min-width: 80px; text-align: right;">
                        ${latestPrice ? `<div class="price" style="font-weight: 500;">Latest: ${currencies[currentRegion]}${latestPrice.price.toFixed(2)}</div>` : `<div class="price">No Price Yet</div>`}
                        <div class="ppu"><button class="btn btn-secondary" style="padding: 0.2rem 0.5rem; font-size: 0.8rem; height: auto;">+ Add Price</button></div>
                    </div>`;
                
                // Add click listener to the whole row
                item.addEventListener('click', () => {
                    // Open price modal, pre-filling the product name AND the current store name
                    openPriceModalForStore(product.name, storeName);
                    // Clear search after clicking
                    document.getElementById('storeProductSearch').value = '';
                    searchProductsForStorePrice(''); 
                });
                searchResults.appendChild(item);
            });
        }

        if (!hasResults) {
            searchResults.innerHTML = `<div class="empty-state"><div class="empty-icon">üîç</div><p>No products found for "${query}"</p></div>`;
        }
    }


    function renderLists() {
      const grid = document.getElementById('listGrid');
      grid.innerHTML = '';

      const lists = allData.filter(item => item.type === 'list');
      if (lists.length === 0) {
        grid.innerHTML = `<div class="empty-state"><div class="empty-icon">üìù</div><p>No shopping lists created</p></div>`;
        return;
      }

      lists.forEach((list, index) => { // Added index for boundary check
        const listItems = allData.filter(item => item.type === 'listItem' && item.listId === list.id);
        const checkedItems = listItems.filter(item => item.checked).length;
        const progress = listItems.length > 0 ? (checkedItems / listItems.length) * 100 : 0;
        const item = document.createElement('div');
        item.className = 'shopping-list-item';
        
        // Add Move Up/Down buttons
        const listItemsOnly = allData.filter(item => item.type === 'list');
        const currentListIndex = listItemsOnly.findIndex(l => l.id === list.id);

        const moveButtons = `
            <div class="list-move-actions flex flex-col gap-1 items-center ml-2 flex-shrink-0">
                <button class="action-btn text-xs bg-gray-100 text-gray-700 hover:bg-gray-200" style="width: 20px; height: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);"
                    onclick="event.stopPropagation(); moveList('${list.id}', 'up')" 
                    ${currentListIndex === 0 ? 'disabled' : ''}>
                    ‚Üë
                </button>
                <button class="action-btn text-xs bg-gray-100 text-gray-700 hover:bg-gray-200" style="width: 20px; height: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);"
                    onclick="event.stopPropagation(); moveList('${list.id}', 'down')" 
                    ${currentListIndex === listItemsOnly.length - 1 ? 'disabled' : ''}>
                    ‚Üì
                </button>
            </div>
        `;
        
        item.innerHTML = `
          <div class="list-icon">üìù</div>
          <div class="list-content">
            <div class="list-header">
              <h3 class="list-name">${list.name}</h3>
              <div class="list-actions">
                <button class="action-btn edit" onclick="event.stopPropagation(); editList('${list.id}', '${list.name.replace(/'/g, "\\'")}')">‚úé</button>
                <button class="action-btn delete" onclick="event.stopPropagation(); deleteList('${list.id}', '${list.name.replace(/'/g, "\\'")}')">‚úï</button>
              </div>
            </div>
            <div class="list-info">${checkedItems}/${listItems.length} items completed</div>
            <div class="progress-bar"><div class="progress-fill" style="width: ${progress}%"></div></div>
          </div>
          ${moveButtons}`; // Append move buttons here

        // Make the main item clickable, but not the action buttons
        item.addEventListener('click', (e) => {
          if (!e.target.closest('.action-btn')) {
            currentList = list.name;
            showSubScreen('listDetailScreen', list.name);
            renderListItems();
          }
        });
        grid.appendChild(item);
      });
    }

    // NEW: Function to render suggested items at the top of the list
    function renderSuggestedItems() {
        const container = document.getElementById('suggestedItemsContainer');
        if (!container) return; // Should always exist on listDetailScreen
        
        const list = allData.find(item => item.type === 'list' && item.name === currentList);
        if (!list) return;

        const currentListItems = allData.filter(item => item.type === 'listItem' && item.listId === list.id).map(item => item.name);
        
        let suggestions = [];
        const MAX_SUGGESTIONS = 5;
        
        // 1. Get Favorites
        const favoriteProducts = allData
            .filter(item => item.type === 'product' && item.isFavorite)
            .map(item => item.name);
            
        // 2. Add non-duplicate favorites first
        favoriteProducts.forEach(productName => {
            if (!currentListItems.includes(productName) && suggestions.length < MAX_SUGGESTIONS) {
                suggestions.push(productName);
            }
        });
        
        // 3. Fill remaining slots with essential products
        essentialProducts.forEach(productName => {
            if (!currentListItems.includes(productName) && !suggestions.includes(productName) && suggestions.length < MAX_SUGGESTIONS) {
                suggestions.push(productName);
            }
        });

        if (suggestions.length === 0) {
            container.innerHTML = '';
            return;
        }

        let suggestionsHtml = '<div class="suggested-items-grid">';
        suggestions.forEach(productName => {
            const productIcon = getProductIcon(productName);
            const escapedName = productName.replace(/'/g, "\\'");
            suggestionsHtml += `
                <div class="suggested-item" onclick="addSuggestedItemToList('${escapedName}', '${list.id}')">
                    <div class="suggested-icon">${productIcon}</div>
                    <div class="suggested-name">${productName}</div>
                </div>
            `;
        });
        suggestionsHtml += '</div>';

        container.innerHTML = `
            <div class="suggested-items-container">
                <h4>Suggested Items (Favorites & Essentials)</h4>
                ${suggestionsHtml}
            </div>
        `;
    }
    
    // NEW: Action to add a suggested item to the current list
    async function addSuggestedItemToList(productName, listId) {
        if (!productName || !listId) return;

        if (allData.length >= 999) {
          showToast('Maximum limit of 999 items reached. Please delete some items first.', 'error');
          return;
        }

        const existingItem = allData.find(item =>
            item.type === 'listItem' &&
            item.listId === listId &&
            item.name === productName
        );

        if (existingItem) {
            showToast('Item already exists in this list', 'error');
            return;
        }
        
        // Find the category for the list item
        const productCategory = getProductCategory(productName);
        
        const listItemData = {
            type: 'listItem',
            name: productName,
            listId: listId,
            itemQuantity: 1,
            checked: false,
            category: productCategory, // Added category
            createdAt: new Date().toISOString()
        };

        const result = await window.dataSdk.create(listItemData);
        if (result.isOk) {
            showToast(`${productName} added to list!`);
        } else {
            showToast('Failed to add item to list', 'error');
        }
    }


    function renderListItems() {
      // Must render suggestions first as they use `currentList`
      renderSuggestedItems();
      
      const container = document.getElementById('listItemsContainer');
      container.innerHTML = '';
      const listTotalContainer = document.getElementById('listTotalContainer'); // ADD
      listTotalContainer.innerHTML = ''; // ADD

      const list = allData.find(item => item.type === 'list' && item.name === currentList);
      if (!list) return;

      const listItems = allData.filter(item => item.type === 'listItem' && item.listId === list.id);

      if (listItems.length === 0) {
        container.innerHTML = `<div class="empty-state"><div class="empty-icon">üõí</div><p>No items in this list</p></div>`;
        listTotalContainer.innerHTML = ''; // ADD - Clear totals
        return;
      }

      // --- ADD TOTAL CALCULATION ---
      let totalListPrice = 0;
      let itemsWithPrice = 0;
      listItems.forEach(listItem => {
        const cheapestPrice = getCheapestPriceForProduct(listItem.name);
        if (cheapestPrice) {
          const pricePerUnit = cheapestPrice.price / cheapestPrice.quantity;
          const itemQuantity = listItem.itemQuantity || 1;
          totalListPrice += pricePerUnit * itemQuantity;
          itemsWithPrice++;
        }
      });

      listTotalContainer.innerHTML = `
        <h3>Total: ${currencies[currentRegion]}${totalListPrice.toFixed(2)}</h3>
        <span>Based on cheapest prices for ${itemsWithPrice} / ${listItems.length} items</span>
      `;
      // --- END TOTAL CALCULATION ---

      if (groupByStore) {
        renderGroupedListItems(listItems, container);
      } else {
        renderFlatListItems(listItems, container);
      }
    }

    function renderFlatListItems(listItems, container) {
      listItems.forEach(listItem => {
        const cheapestPrice = getCheapestPriceForProduct(listItem.name);
        const productIcon = getProductIcon(listItem.name); // Get icon

        // --- ADD Price calculation ---
        let priceHtml = '<div class="item-price-details">No price data</div>';
        if (cheapestPrice) {
          const pricePerUnit = cheapestPrice.price / cheapestPrice.quantity;
          const totalProductPrice = pricePerUnit * (listItem.itemQuantity || 1);
          priceHtml = `
            <div class="item-price-details">
                <span class="item-store">@ ${cheapestPrice.store}</span>
                <span class="item-total-price">${currencies[currentRegion]}${totalProductPrice.toFixed(2)}</span>
            </div>
            `;
        }
        // --- END Price calculation ---

        const item = document.createElement('div');
        item.className = `list-item ${listItem.checked ? 'checked' : ''}`;
        item.innerHTML = `
          <div class="list-item-main">
            <button class="check-button ${listItem.checked ? 'checked' : ''}" onclick="event.stopPropagation(); toggleListItem('${listItem.id}')">${listItem.checked ? '‚úì' : ''}</button>
            <div class="list-item-icon">${productIcon}</div>
            <div class="item-details">
              <div class="item-name">${listItem.name}</div>
              ${priceHtml} <!-- REPLACE old price line -->
            </div>
          </div>
          <div class="list-item-controls">
            <div class="qty-adjuster">
                <button class="qty-btn" data-action="decrease" onclick="event.stopPropagation(); adjustListItemQuantity('${listItem.id}', -1)">-</button>
                <span style="min-width: 1.2rem; text-align: center;">${listItem.itemQuantity || 1}</span>
                <button class="qty-btn" data-action="increase" onclick="event.stopPropagation(); adjustListItemQuantity('${listItem.id}', 1)">+</button>
            </div>
            <button class="list-delete-btn" onclick="event.stopPropagation(); deleteListItem('${listItem.id}')">‚úï</button>
          </div>`;

        // --- RE-WIRE EVENTS ---
        
        // Make item clickable to show product details
        const itemDetails = item.querySelector('.item-details');
        itemDetails.style.cursor = 'pointer';
        itemDetails.addEventListener('click', () => {
          showProductDetail(listItem.name);
        });

        container.appendChild(item);
      });
    }

    function renderGroupedListItems(listItems, container) {
      const grouped = {};
      listItems.forEach(listItem => {
        const cheapestPrice = getCheapestPriceForProduct(listItem.name);
        const store = cheapestPrice ? cheapestPrice.store : 'No price data';
        if (!grouped[store]) {
          grouped[store] = [];
        }
        grouped[store].push({ ...listItem,
          cheapestPrice
        });
      });

      Object.entries(grouped).forEach(([storeName, items]) => {
        const group = document.createElement('div');
        group.className = 'store-group';
        const header = document.createElement('div');
        header.className = 'store-group-header';

        // --- ADD Store Total Calculation ---
        let storeTotalPrice = 0;
        items.forEach(listItem => {
          if (listItem.cheapestPrice) {
            const pricePerUnit = listItem.cheapestPrice.price / listItem.cheapestPrice.quantity;
            storeTotalPrice += pricePerUnit * (listItem.itemQuantity || 1);
          }
        });

        const storeTotalHtml = storeName === 'No price data' ? '' : `
            <span style="font-weight: 700; color: #059669;">
                ${currencies[currentRegion]}${storeTotalPrice.toFixed(2)}
            </span>
        `;
        header.innerHTML = `<span>${storeName}</span> ${storeTotalHtml}`;
        // --- END Store Total Calculation ---

        group.appendChild(header);

        items.forEach(listItem => {
          const productIcon = getProductIcon(listItem.name); // Get icon

          // --- ADD Price calculation ---
          let priceHtml = '<div class="item-price-details">No price data</div>';
          if (listItem.cheapestPrice) {
            const pricePerUnit = listItem.cheapestPrice.price / listItem.cheapestPrice.quantity;
            const totalProductPrice = pricePerUnit * (listItem.itemQuantity || 1);
            priceHtml = `
              <div class="item-price-details">
                  <span class="item-store">${currencies[currentRegion]}${pricePerUnit.toFixed(2)}/${listItem.cheapestPrice.unit}</span>
                  <span class="item-total-price">${currencies[currentRegion]}${totalProductPrice.toFixed(2)}</span>
              </div>
              `;
          }
          // --- END Price calculation ---

          const item = document.createElement('div');
          item.className = `list-item ${listItem.checked ? 'checked' : ''}`;
          item.innerHTML = `
            <div class="list-item-main">
              <button class="check-button ${listItem.checked ? 'checked' : ''}" onclick="event.stopPropagation(); toggleListItem('${listItem.id}')">${listItem.checked ? '‚úì' : ''}</button>
              <div class="list-item-icon">${productIcon}</div>
              <div class="item-details">
                <div class="item-name">${listItem.name}</div>
                ${priceHtml} <!-- REPLACE old price line -->
              </div>
            </div>
            <div class="list-item-controls">
              <div class="qty-adjuster">
                  <button class="qty-btn" data-action="decrease" onclick="event.stopPropagation(); adjustListItemQuantity('${listItem.id}', -1)">-</button>
                  <span style="min-width: 1.2rem; text-align: center;">${listItem.itemQuantity || 1}</span>
                  <button class="qty-btn" data-action="increase" onclick="event.stopPropagation(); adjustListItemQuantity('${listItem.id}', 1)">+</button>
              </div>
              <button class="list-delete-btn" onclick="event.stopPropagation(); deleteListItem('${listItem.id}')">‚úï</button>
            </div>`;

          // --- RE-WIRE EVENTS ---
          
          // Make item clickable to show product details
          const itemDetails = item.querySelector('.item-details');
          itemDetails.style.cursor = 'pointer';
          itemDetails.addEventListener('click', () => {
            showProductDetail(listItem.name);
          });

          group.appendChild(item);
        });
        container.appendChild(group);
      });
    }

    // Helper functions
    function getCheapestPrice(prices) {
      if (prices.length === 0) return null;
      return prices.reduce((cheapest, current) => {
        const currentPPU = current.price / current.quantity;
        const cheapestPPU = cheapest.price / cheapest.quantity;
        return currentPPU < cheapestPPU ? current : cheapest;
      });
    }

    function getCheapestPriceForProduct(productName) {
      const prices = allData.filter(item => item.type === 'price' && item.name === productName);
      return getCheapestPrice(prices);
    }
    
    function getCustomProductRecord(productName) {
        return allData.find(item => item.type === 'product' && item.name === productName);
    }

    function getAllProductNames() {
      const predefinedProducts = Object.values(categories).flatMap(cat => cat.products);
      const customProducts = allData.filter(item => item.type === 'product').map(p => p.name);
      return [...new Set([...predefinedProducts, ...customProducts])];
    }

    function getProductCategory(productName) {
      // 1. Check custom products first
      const customProduct = allData.find(item => item.type === 'product' && item.name === productName);
      if (customProduct && customProduct.category) {
        return customProduct.category;
      }

      // 2. Check predefined products
      for (const category in categories) {
        if (categories[category].products.includes(productName)) {
          return category;
        }
      }
      // 3. Fallback
      return 'Unknown';
    }
    
    function getProductIcon(productName) {
      // Check custom products first
      const customProduct = getCustomProductRecord(productName);
      if (customProduct && customProduct.icon) {
        return customProduct.icon;
      }
      // Check predefined
      return productIcons[productName] || 'üì¶';
    }

    async function adjustListItemQuantity(listItemId, amount) {
      if (!isAuthReady) { showToast("Please sign in to save data.", 'error'); return; }
      const listItem = allData.find(item => item.type === 'listItem' && item.id === listItemId);
      if (!listItem) return;

      const newQuantity = (listItem.itemQuantity || 1) + amount;
      if (newQuantity < 1) {
        // Just delete the item if quantity goes to zero via the '-' button
        await deleteListItem(listItem);
        return;
      }
      const updatedItem = { ...listItem,
        itemQuantity: newQuantity
      };
      const result = await window.dataSdk.update(updatedItem);
      if (!result.isOk) {
        showToast('Failed to update quantity', 'error');
      }
    }

    async function deleteListItem(listItem) {
      if (!isAuthReady) { showToast("Please sign in to save data.", 'error'); return; }
      const result = await window.dataSdk.delete(listItem);
      if (result.isOk) {
        showToast('Item removed from list');
      } else {
        showToast('Failed to remove item', 'error');
      }
    }
    
    // NEW: Function to move the list order (using mock logic)
    async function moveList(listId, direction) {
        // Since we rely on Firestore's default ordering (by creation time),
        // manual reordering is complex and requires adding an 'order' field to the document.
        // For this demo, we'll notify the user this feature is advanced.
        showToast("Moving list order is disabled in this version for stability. Try sorting your list by store!", "error");
    }


    function updateCurrentView() {
      if (currentProduct) { // Check for product detail screen first
        renderProductDetail();
      } else if (currentCategory) {
        const searchInput = document.getElementById('productSearch');
        // Only render products if no search is active
        if (searchInput && searchInput.value.trim() === '') {
          renderProducts();
        } else if (searchInput) {
          // If a search is active, keep the search results updated
          performProductSearch(searchInput.value.trim());
        }
      } else if (currentStore) {
        // Check both search bars for the store screen
        const listSearchInput = document.getElementById('storeProductSearch');
        if (listSearchInput && listSearchInput.value.trim() !== '') {
            searchProductsForStorePrice(listSearchInput.value.trim());
        } else {
            renderStoreProducts();
        }
      } else if (currentList) {
        renderListItems();
      } else if (currentScreen === 'favorites') {
        renderFavorites();
      } else {
        switch (currentScreen) {
          case 'categories':
            renderCategories();
            break;
          case 'stores':
            renderStores();
            break;
          case 'lists':
            renderLists();
            break;
          case 'auth': // If logged out, render auth screen (handled by onAuthStateChanged but useful for explicit calls)
             authScreenEl.classList.add('active');
             authScreenEl.style.display = 'flex';
             break;
        }
      }
    }

    function updateCountryFlag() {
      const flags = {
        CA: 'üá®üá¶',
        US: 'üá∫üá∏',
        UK: 'üá¨üáß'
      };
      document.getElementById('countryFlag').textContent = flags[currentRegion];
    }

    // Modal functions
    function openModal(modalId) {
      document.getElementById(modalId).classList.add('active');
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }

    function openPriceModal(productName) { // Used by Product Detail screen's '+' button
      document.getElementById('priceProductName').value = productName;
      populateStoreSelect('priceStore');
      calculatePPU();
      openModal('addPriceModal');
    }

    // NEW: Function used by the Store Detail screen's search results
    function openPriceModalForStore(productName, storeName) {
        document.getElementById('priceProductName').value = productName;
        populateStoreSelect('priceStore');
        document.getElementById('priceStore').value = storeName; // Pre-select the store
        calculatePPU();
        openModal('addPriceModal');
    }

    function openEditPriceModal(priceId) {
      const price = allData.find(item => item.id === priceId && item.type === 'price');
      if (!price) {
        showToast('Price record not found', 'error');
        return;
      }
      currentEditingPrice = price;

      document.getElementById('editPriceProductName').value = price.name;
      document.getElementById('editPriceAmount').value = price.price;
      document.getElementById('editPriceQuantity').value = price.quantity;
      
      populateStoreSelect('editPriceStore');
      document.getElementById('editPriceStore').value = price.store;
      document.getElementById('editPriceUnit').value = price.unit;
      
      calculateEditPPU();
      openModal('editPriceModal');
    }

    function openEditStoreModal(storeName) {
        const store = allData.find(item => item.type === 'store' && item.name === storeName);
        if (!store) {
            showToast('Cannot edit predefined stores.', 'error');
            return;
        }
        currentEditingStore = store;
        document.getElementById('editStoreName').value = storeName;
        openModal('editStoreModal');
    }

    function populateStoreSelect(selectId) {
      const select = document.getElementById(selectId);
      select.innerHTML = '';
      let storeList = [...stores[currentRegion]];
      const customStores = allData.filter(item => item.type === 'store' && item.region === currentRegion);
      storeList = [...storeList, ...customStores.map(s => s.name)];
      
      storeList.sort((a, b) => a.localeCompare(b));
      
      storeList.forEach(store => {
        const option = document.createElement('option');
        option.value = store;
        option.textContent = store;
        select.appendChild(option);
      });
    }

    function populateProductCategories() {
      const select = document.getElementById('newProductCategory');
      select.innerHTML = '';
      // Get all categories (predefined + custom)
      const allCategories = [...Object.keys(categories), ...allData.filter(item => item.type === 'category').map(c => c.name)];
      
      // Sort and add
      [...new Set(allCategories)].sort((a, b) => a.localeCompare(b)).forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        select.appendChild(option);
      });
    }

    function calculatePPU() {
      const price = parseFloat(document.getElementById('priceAmount').value) || 0;
      const quantity = parseFloat(document.getElementById('priceQuantity').value) || 1;
      const unit = document.getElementById('priceUnit').value || currentUnit;
      const ppu = quantity > 0 ? price / quantity : 0;
      document.getElementById('calculatedPPU').textContent =
        `Price per unit: ${currencies[currentRegion]}${ppu.toFixed(2)}/${unit}`;
    }

    function calculateEditPPU() {
      const price = parseFloat(document.getElementById('editPriceAmount').value) || 0;
      const quantity = parseFloat(document.getElementById('editPriceQuantity').value) || 1;
      const unit = document.getElementById('editPriceUnit').value || currentUnit;
      const ppu = quantity > 0 ? price / quantity : 0;
      document.getElementById('editCalculatedPPU').textContent =
        `Price per unit: ${currencies[currentRegion]}${ppu.toFixed(2)}/${unit}`;
    }

    function calculateQuickPPU() {
      const price = parseFloat(document.getElementById('quickPrice').value) || 0;
      const quantity = parseFloat(document.getElementById('quickQuantity').value) || 1;
      const unit = document.getElementById('quickUnit').value || currentUnit;
      const ppu = quantity > 0 ? price / quantity : 0;
      document.getElementById('quickCalculatedPPU').textContent =
        `Price per unit: ${currencies[currentRegion]}${ppu.toFixed(2)}/${unit}`;
    }

    // Save functions
    async function savePrice() {
      if (!isAuthReady) { showToast("Please sign in to save data.", 'error'); return; }
      const productName = document.getElementById('priceProductName').value;
      const store = document.getElementById('priceStore').value;
      const price = parseFloat(document.getElementById('priceAmount').value);
      const quantity = parseFloat(document.getElementById('priceQuantity').value);
      const unit = document.getElementById('priceUnit').value;

      if (!productName || !store || isNaN(price) || isNaN(quantity) || price <= 0) {
        showToast('Please enter valid price and quantity', 'error');
        return;
      }

      if (allData.length >= 999) {
        showToast('Maximum limit of 999 items reached. Please delete some items first.', 'error');
        return;
      }

      // Find the correct category for the price record
      const category = getProductCategory(productName);

      const priceData = {
        type: 'price',
        name: productName,
        category: category,
        store: store,
        price: price,
        quantity: quantity,
        unit: unit,
        region: currentRegion,
        createdAt: new Date().toISOString()
      };

      const result = await window.dataSdk.create(priceData);
      if (result.isOk) {
        showToast('Price saved successfully');
        closeModal('addPriceModal');
        // Clear form
        document.getElementById('priceAmount').value = '';
        document.getElementById('priceQuantity').value = '';
      } else {
        showToast('Failed to save price', 'error');
      }
    }
    
    async function updatePrice() {
        if (!isAuthReady) { showToast("Please sign in to save data.", 'error'); return; }
        if (!currentEditingPrice) return;
        
        const price = parseFloat(document.getElementById('editPriceAmount').value);
        const quantity = parseFloat(document.getElementById('editPriceQuantity').value);
        const unit = document.getElementById('editPriceUnit').value;
        const store = document.getElementById('editPriceStore').value;
        
        if (!store || isNaN(price) || isNaN(quantity) || price <= 0) {
            showToast('Please enter valid price and quantity', 'error');
            return;
        }
        
        const updatedPrice = {
            ...currentEditingPrice,
            store: store,
            price: price,
            quantity: quantity,
            unit: unit,
            // Keep original category and name (product logic handles updates)
        };
        
        const result = await window.dataSdk.update(updatedPrice);
        
        if (result.isOk) {
            showToast('Price updated successfully');
            closeModal('editPriceModal');
            currentEditingPrice = null;
        } else {
            showToast('Failed to update price', 'error');
        }
    }
    
    async function deletePrice() {
        if (!isAuthReady) { showToast("Please sign in to save data.", 'error'); return; }
        if (!currentEditingPrice) return;
        
        const result = await window.dataSdk.delete(currentEditingPrice);
        
        if (result.isOk) {
            showToast('Price deleted successfully');
            closeModal('editPriceModal');
            currentEditingPrice = null;
        } else {
            showToast('Failed to delete price', 'error');
        }
    }

    async function saveProduct() {
      if (!isAuthReady) { showToast("Please sign in to save data.", 'error'); return; }
      const name = document.getElementById('newProductName').value.trim();
      const brand = document.getElementById('newProductBrand').value.trim();
      const category = document.getElementById('newProductCategory').value;
      const icon = document.getElementById('newProductIcon').value.trim();
      const tagsInput = document.getElementById('newProductTags').value.trim();

      if (!name || !category) {
        showToast('Please fill required fields', 'error');
        return;
      }

      if (allData.length >= 999) {
        showToast('Maximum limit of 999 items reached. Please delete some items first.', 'error');
        return;
      }

      // Check if product with same name and brand already exists
      const existingCustomProduct = allData.find(item =>
        item.type === 'product' &&
        item.name.toLowerCase() === name.toLowerCase() &&
        (item.brand || '').toLowerCase() === (brand || '').toLowerCase()
      );

      // Check predefined products (they don't have brands, so only check if no brand specified)
      let existingPredefinedProduct = false;
      if (!brand) {
        Object.values(categories).forEach(categoryData => {
          if (categoryData.products.some(product => product.toLowerCase() === name.toLowerCase())) {
            existingPredefinedProduct = true;
          }
        });
      }

      if (existingCustomProduct || existingPredefinedProduct) {
        showToast('Product with this name and brand already exists', 'error');
        return;
      }

      const productData = {
        type: 'product',
        name: name,
        brand: brand,
        category: category,
        icon: icon,
        tags: tagsInput,
        isFavorite: false, // NEW: Default to false
        createdAt: new Date().toISOString()
      };

      const result = await window.dataSdk.create(productData);
      if (result.isOk) {
        showToast('Product added successfully');
        closeModal('addProductModal');
        // Clear form
        document.getElementById('newProductName').value = '';
        document.getElementById('newProductBrand').value = '';
        document.getElementById('newProductIcon').value = '';
        document.getElementById('newProductTags').value = '';
      } else {
        showToast('Failed to add product', 'error');
      }
    }

    async function saveStore() {
      if (!isAuthReady) { showToast("Please sign in to save data.", 'error'); return; }
      const name = document.getElementById('newStoreName').value.trim();

      if (!name) {
        showToast('Please enter store name', 'error');
        return;
      }

      if (allData.length >= 999) {
        showToast('Maximum limit of 999 items reached. Please delete some items first.', 'error');
        return;
      }

      // Check if store name already exists (predefined or custom)
      const existingCustomStore = allData.find(item =>
        item.type === 'store' &&
        item.region === currentRegion &&
        item.name.toLowerCase() === name.toLowerCase()
      );

      // Check predefined stores
      const existingPredefinedStore = stores[currentRegion].some(storeName => storeName.toLowerCase() === name.toLowerCase());

      if (existingCustomStore || existingPredefinedStore) {
        showToast('Store name already in use', 'error');
        return;
      }

      const storeData = {
        type: 'store',
        name: name,
        region: currentRegion,
        createdAt: new Date().toISOString()
      };

      const result = await window.dataSdk.create(storeData);
      if (result.isOk) {
        showToast('Store added successfully');
        closeModal('addStoreModal');
        document.getElementById('newStoreName').value = '';
      } else {
        showToast('Failed to add store', 'error');
      }
    }
    
    async function updateStore() {
        if (!isAuthReady) { showToast("Please sign in to save data.", 'error'); return; }
        if (!currentEditingStore) return;
        const name = document.getElementById('editStoreName').value.trim();
        
        if (!name) {
            showToast('Please enter store name', 'error');
            return;
        }

        // Check for conflicts
        const existingStore = allData.find(item =>
            item.type === 'store' &&
            item.id !== currentEditingStore.id &&
            item.name.toLowerCase() === name.toLowerCase()
        );
        const existingPredefinedStore = stores[currentRegion].some(storeName => storeName.toLowerCase() === name.toLowerCase());

        if (existingStore || existingPredefinedStore) {
            showToast('Store name already in use', 'error');
            return;
        }
        
        const oldName = currentEditingStore.name;
        
        const updatedStore = {
            ...currentEditingStore,
            name: name
        };
        
        const result = await window.dataSdk.update(updatedStore);
        
        if (result.isOk) {
            // Update all related prices with the new store name
            const relatedPrices = allData.filter(item => item.type === 'price' && item.store === oldName);
            for (const price of relatedPrices) {
                const updatedPrice = { ...price, store: name };
                // Use SDK update mock
                await window.dataSdk.update(updatedPrice);
            }
            
            showToast('Store updated successfully');
            closeModal('editStoreModal');
            currentEditingStore = null;
        } else {
            showToast('Failed to update store', 'error');
        }
    }
    
    async function deleteStore(storeName) {
        if (!isAuthReady) { showToast("Please sign in to save data.", 'error'); return; }
        const storeToDelete = allData.find(item => item.type === 'store' && item.name === storeName);
        if (!storeToDelete) {
            showToast('Cannot delete predefined stores.', 'error');
            return;
        }
        
        const pricesToDelete = allData.filter(item => item.type === 'price' && item.store === storeName);
        
        // Use deleteConfirmModal for confirmation
        currentDeletingItem = {
            id: storeToDelete.id,
            type: 'store',
            name: storeName,
            isCustom: true
        };
        document.getElementById('deleteMessage').textContent =
            `Are you sure you want to delete the store "${storeName}"? This will also permanently delete ${pricesToDelete.length} associated price record(s).`;
        document.getElementById('confirmDeleteBtn').onclick = async () => {
            closeModal('deleteConfirmModal');
            try {
                // Delete prices first using batch delete for efficiency
                if (pricesToDelete.length > 0) {
                    await window.dataSdk.deleteBatch(pricesToDelete);
                }
                
                // Delete the store
                const result = await window.dataSdk.delete(storeToDelete);
                if (result.isOk) {
                    showToast('Store and related prices deleted successfully');
                } else {
                    showToast('Failed to delete store', 'error');
                }
            } catch (error) {
                showToast('An error occurred during deletion.', 'error');
            }
            currentDeletingItem = null;
        };
        openModal('deleteConfirmModal');
    }
    
    function duplicateStore(storeName) {
        const existingStore = stores[currentRegion].includes(storeName) ? { name: storeName } : allData.find(item => item.type === 'store' && item.name === storeName);
        
        document.getElementById('newStoreName').value = existingStore.name + ' (Copy)';
        openModal('addStoreModal');
    }

    async function saveList() {
      if (!isAuthReady) { 
        showToast("Please sign in to create a list.", 'error'); 
        return; 
      }
      
      const name = document.getElementById('newListName').value.trim();

      if (!name) {
        showToast('Please enter list name', 'error');
        return;
      }

      if (allData.length >= 999) {
        showToast('Maximum limit of 999 items reached. Please delete some items first.', 'error');
        return;
      }

      // Check if list name already exists
      const existingList = allData.find(item =>
        item.type === 'list' && item.name.toLowerCase() === name.toLowerCase()
      );

      if (existingList) {
        showToast('List name already in use', 'error');
        return;
      }

      const listData = {
        type: 'list',
        name: name,
        createdAt: new Date().toISOString()
      };

      const result = await window.dataSdk.create(listData);
      if (result.isOk) {
        showToast('List created successfully');
        closeModal('addListModal');
        document.getElementById('newListName').value = '';
      } else {
        showToast('Failed to create list', 'error');
      }
    }

    async function saveCategory() {
      if (!isAuthReady) { showToast("Please sign in to save data.", 'error'); return; }
      const name = document.getElementById('newCategoryName').value.trim();
      const icon = document.getElementById('newCategoryIcon').value.trim() || 'üõí';

      if (!name) {
        showToast('Please enter category name', 'error');
        return;
      }

      if (allData.length >= 999) {
        showToast('Maximum limit of 999 items reached. Please delete some items first.', 'error');
        return;
      }

      // Check if category name already exists (predefined or custom)
      const existingCustomCategory = allData.find(item =>
        item.type === 'category' && item.name.toLowerCase() === name.toLowerCase()
      );

      // Check predefined categories
      const existingPredefinedCategory = Object.keys(categories).some(categoryName => categoryName.toLowerCase() === name.toLowerCase());

      if (existingCustomCategory || existingPredefinedCategory) {
        showToast('Category name already in use', 'error');
        return;
      }

      const categoryData = {
        type: 'category',
        name: name,
        icon: icon,
        createdAt: new Date().toISOString()
      };

      const result = await window.dataSdk.create(categoryData);
      if (result.isOk) {
        showToast('Category added successfully');
        closeModal('addCategoryModal');
        document.getElementById('newCategoryName').value = '';
        document.getElementById('newCategoryIcon').value = '';
      } else {
        showToast('Failed to add category', 'error');
      }
    }

    async function saveUnit() {
      const unit = document.getElementById('unitSelect').value;
      currentUnit = unit;
      document.getElementById('currentUnit').textContent = unit;
      showToast('Unit preference saved');
      closeModal('unitModal');
    }

    async function saveCountry() {
      const country = document.getElementById('countrySelect').value;
      currentRegion = country;
      updateCountryFlag();
      const countryNames = {
        CA: 'üá®üá¶',
        US: 'üá∫üá∏',
        UK: 'üá¨üáß'
      };
      document.getElementById('currentCountry').textContent = countryNames[country];
      renderStores();
      showToast('Country preference saved');
      closeModal('countryModal');
    }

    async function saveQuickAdd() {
      if (!isAuthReady) { showToast("Please sign in to save data.", 'error'); return; }
      const name = document.getElementById('quickProductName').value.trim();
      const brand = document.getElementById('quickProductBrand').value.trim();
      const category = document.getElementById('quickProductCategory').value;
      const icon = document.getElementById('quickProductIcon').value.trim();
      const tagsInput = document.getElementById('quickProductTags').value.trim();
      const store = document.getElementById('quickStore').value;
      const price = parseFloat(document.getElementById('quickPrice').value);
      const quantity = parseFloat(document.getElementById('quickQuantity').value);
      const unit = document.getElementById('quickUnit').value;

      if (!name || !category || !store || isNaN(price) || isNaN(quantity) || price <= 0) {
        showToast('Please fill all required fields with valid values', 'error');
        return;
      }

      if (allData.length >= 999) {
        showToast('Maximum limit of 999 items reached. Please delete some items first.', 'error');
        return;
      }

      // Check if we need to create a new product
      const existingProduct = allData.find(item =>
        item.type === 'product' &&
        item.name.toLowerCase() === name.toLowerCase() &&
        (item.brand || '').toLowerCase() === (brand || '').toLowerCase()
      );

      let productExists = existingProduct !== undefined;
      // Check predefined products
      if (!productExists && !brand) {
        Object.values(categories).forEach(categoryData => {
          if (categoryData.products.some(product => product.toLowerCase() === name.toLowerCase())) {
            productExists = true;
          }
        });
      }

      // Create product if it doesn't exist
      if (!productExists) {
        const productData = {
          type: 'product',
          name: name,
          brand: brand,
          category: category,
          icon: icon,
          tags: tagsInput,
          isFavorite: false, // NEW: Default to false
          createdAt: new Date().toISOString()
        };

        const productResult = await window.dataSdk.create(productData);
        if (!productResult.isOk) {
          showToast('Failed to create product', 'error');
          return;
        }
      }

      // Create price
      const priceData = {
        type: 'price',
        name: name,
        category: category,
        store: store,
        price: price,
        quantity: quantity,
        unit: unit,
        region: currentRegion,
        createdAt: new Date().toISOString()
      };

      const priceResult = await window.dataSdk.create(priceData);
      if (priceResult.isOk) {
        showToast('Product and price saved successfully');
        closeModal('quickAddModal');
        // Clear form
        document.getElementById('quickProductName').value = '';
        document.getElementById('quickProductBrand').value = '';
        document.getElementById('quickProductIcon').value = '';
        document.getElementById('quickProductTags').value = '';
        document.getElementById('quickPrice').value = '';
        document.getElementById('quickQuantity').value = '1';
      } else {
        showToast('Failed to save price', 'error');
      }
    }

    // Product action functions
    function openAddToListModal(productName) {
      if (!isAuthReady) { showToast("Please sign in to view this.", 'error'); return; }
      selectedProductForList = productName;
      document.getElementById('listProductName').value = productName;
      populateExistingLists();
      openModal('addToListModal');
    }

    function showProductDetail(productName) {
      currentProduct = productName;
      showSubScreen('productDetailScreen', productName);
      renderProductDetail();
    }

    // NEW: Function to toggle favorite status
    async function toggleFavorite(productName) {
        if (!isAuthReady) { showToast("Please sign in to save data.", 'error'); return; }
        let customProduct = getCustomProductRecord(productName);
        
        let targetProduct = customProduct;
        let isNew = false;
        
        if (!customProduct) {
            // If it's a predefined product, create a new custom product entry first
            const category = getProductCategory(productName);
            const icon = getProductIcon(productName);
            targetProduct = {
                type: 'product',
                name: productName,
                brand: '',
                category: category,
                icon: icon,
                tags: '',
                isFavorite: true, // Set favorite status on creation
                createdAt: new Date().toISOString()
            };
            isNew = true;
        } else {
            // Toggle existing favorite status
            targetProduct = {
                ...customProduct,
                isFavorite: !customProduct.isFavorite
            };
        }

        let result;
        if (isNew) {
            result = await window.dataSdk.create(targetProduct);
        } else {
            result = await window.dataSdk.update(targetProduct);
        }

        if (result.isOk) {
            showToast(targetProduct.isFavorite ? `${productName} added to favorites!` : `${productName} removed from favorites.`);
            // Rerender current view to update star icons instantly
            updateCurrentView();
        } else {
            showToast('Failed to update favorite status', 'error');
        }
    }
    
    // NEW: Toggles the state of a list item
    async function toggleListItem(listItemId) {
        if (!isAuthReady) { showToast("Please sign in to save data.", 'error'); return; }
        const listItem = allData.find(item => item.type === 'listItem' && item.id === listItemId);
        if (!listItem) return;
        
        const updatedItem = {
            ...listItem,
            checked: !listItem.checked
        };
        
        const result = await window.dataSdk.update(updatedItem);
        if (!result.isOk) {
            showToast('Failed to toggle list item status.', 'error');
        }
    }
    
    // NEW: Toggles the grouping mode
    function toggleGrouping() {
        groupByStore = !groupByStore;
        const toggleSwitch = document.getElementById('groupToggle');
        if (toggleSwitch) {
            if (groupByStore) {
                toggleSwitch.classList.add('active');
            } else {
                toggleSwitch.classList.remove('active');
            }
        }
        renderListItems();
    }
    
    // Helper function to render product detail content (header, prices, etc.)
    function renderProductDetail() {
        if (!currentProduct) return;
        
        const prices = allData.filter(item => item.type === 'price' && item.name === currentProduct);
        const cheapestPrice = getCheapestPrice(prices);
        const productIcon = getProductIcon(currentProduct);
        const category = getProductCategory(currentProduct);
        const customProduct = getCustomProductRecord(currentProduct);
        const brand = customProduct?.brand || '';
        const isFavorite = customProduct?.isFavorite || false;
        
        // 1. Render Header
        const headerEl = document.getElementById('productDetailHeader');
        headerEl.innerHTML = `
            <button class="action-btn favorite" style="position: absolute; bottom: 1rem; left: 1rem; opacity: 1;"
                    onclick="event.stopPropagation(); toggleFavorite('${currentProduct.replace(/'/g, "\\'")}')">
                ${isFavorite ? '‚òÖ' : '‚òÜ'}
            </button>
            <div class="product-icon">${productIcon}</div>
            <div class="product-detail-name">${currentProduct}</div>
            ${brand ? `<div class="product-brand">${brand}</div>` : ''}
            <div class="product-detail-category">${category}</div>
            ${cheapestPrice ? `<div class="price-value" style="font-size: 1.1rem; margin-top: 0.5rem; color: #059669; font-weight: 700;">Cheapest: ${currencies[currentRegion]}${cheapestPrice.price.toFixed(2)} (${currencies[currentRegion]}${(cheapestPrice.price / cheapestPrice.quantity).toFixed(2)}/${cheapestPrice.unit})</div>` : `<div class="price-value" style="font-size: 1.1rem; margin-top: 0.5rem; color: #64748b;">No Price Recorded</div>`}
        `;
        
        // 2. Render Prices List
        const pricesListEl = document.getElementById('pricesList');
        pricesListEl.innerHTML = '';
        
        if (prices.length === 0) {
            pricesListEl.innerHTML = `<div class="empty-state"><div class="empty-icon">üè∑Ô∏è</div><p>No price records found.</p></div>`;
            return;
        }
        
        // Sort prices by date (newest first)
        prices.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

        prices.forEach(price => {
            const date = new Date(price.createdAt).toLocaleDateString();
            const isCheapest = price === cheapestPrice;
            
            const item = document.createElement('div');
            item.className = 'price-item';
            item.innerHTML = `
                <div>
                    <div class="price-store-name" style="color: ${isCheapest ? '#059669' : '#374151'}; font-weight: ${isCheapest ? '700' : '600'};">
                        ${price.store} ${isCheapest ? '‚≠ê' : ''}
                    </div>
                    <div class="price-date">${date} (${price.quantity} ${price.unit})</div>
                </div>
                <div class="price-amount">
                    <div class="price-value">${currencies[currentRegion]}${price.price.toFixed(2)}</div>
                    <div class="price-ppu">${currencies[currentRegion]}${(price.price / price.quantity).toFixed(2)}/${price.unit}</div>
                </div>
            `;
            item.addEventListener('click', () => openEditPriceModal(price.id));
            pricesListEl.appendChild(item);
        });
        
        // 3. Render Chart (only if prices exist)
        renderPriceHistoryChart(prices);
    }
    
    // Helper function to destroy existing chart instance
    function destroyChart() {
        if (chartInstance) {
            chartInstance.destroy();
            chartInstance = null;
        }
    }

    // Helper function to render price history chart
    function renderPriceHistoryChart(prices) {
        destroyChart(); // Ensure previous chart is destroyed
        const chartElement = document.getElementById('priceHistoryChart');
        if (!chartElement) return;

        const ctx = chartElement.getContext('2d');
        if (!ctx) return;

        if (prices.length < 2) {
            // Restore canvas element if it was replaced by empty state message
            if (chartElement.tagName !== 'CANVAS') {
                 const newCanvas = document.createElement('canvas');
                 newCanvas.id = 'priceHistoryChart';
                 chartElement.parentNode.appendChild(newCanvas);
            }
            
            chartElement.parentNode.innerHTML = `<div class="empty-state"><div class="empty-icon">üìà</div><p>Need 2+ price records to show history.</p></div>`;
            return;
        }
        
        // 1. Group prices by year-month and find the minimum PPU
        const monthlyData = {};
        prices.forEach(p => {
            const date = new Date(p.createdAt);
            const yearMonth = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            const ppu = p.price / p.quantity;
            
            if (!monthlyData[yearMonth] || ppu < monthlyData[yearMonth].ppu) {
                monthlyData[yearMonth] = {
                    ppu: ppu,
                    date: date // Keep the date object for sorting
                };
            }
        });

        // 2. Prepare chart data (sort by date)
        const sortedMonths = Object.entries(monthlyData)
            .sort((a, b) => new Date(a[1].date) - new Date(b[1].date));
            
        const labels = sortedMonths.map(([month, data]) => {
            const date = data.date;
            return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
        });
        
        const dataPoints = sortedMonths.map(([month, data]) => data.ppu);

        // 3. Create Chart
        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Cheapest Price Per Unit',
                    data: dataPoints,
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.2)',
                    fill: 'start',
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: `PPU (${currencies[currentRegion]})`
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += `${currencies[currentRegion]}${context.parsed.y.toFixed(2)}`;
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });
    }

    // Product suggestions for Quick Add
    function showProductSuggestions() {
      const input = document.getElementById('quickProductName');
      const suggestions = document.getElementById('productSuggestions');
      const query = input.value.toLowerCase().trim();

      if (!query) {
        suggestions.style.display = 'none';
        return;
      }

      const matchingProducts = [];
      // Search all products
      const allProductNames = getAllProductNames();

      allProductNames.forEach(productName => {
        if (productName.toLowerCase().includes(query)) {
          const category = getProductCategory(productName);
          matchingProducts.push({ name: productName, category: category });
        }
      });


      if (matchingProducts.length > 0) {
        suggestions.innerHTML = '';
        matchingProducts.slice(0, 5).forEach(product => {
          const item = document.createElement('div');
          item.className = 'suggestion-item';
          item.innerHTML = `
            <div class="suggestion-name">${product.name}</div>
            <div class="suggestion-category">${product.category}</div>`;
          item.addEventListener('click', () => {
            input.value = product.name;
            document.getElementById('quickProductCategory').value = product.category;
            // Fill brand and tags if it's a custom product
            const customProduct = getCustomProductRecord(product.name);
            if (customProduct) {
              document.getElementById('quickProductBrand').value = customProduct.brand || '';
              document.getElementById('quickProductTags').value = customProduct.tags || '';
              document.getElementById('quickProductIcon').value = customProduct.icon || '';
            } else {
                // Pre-fill icon for predefined product
                document.getElementById('quickProductIcon').value = getProductIcon(product.name);
            }
            suggestions.style.display = 'none';
            calculateQuickPPU(); // Re-calculate PPU based on current inputs
          });
          suggestions.appendChild(item);
        });
        suggestions.style.display = 'block';
      } else {
        suggestions.style.display = 'none';
      }
    }

    function openQuickAddModal() {
      populateProductCategories();
      populateStoreSelect('quickStore');
      
      const categorySelect = document.getElementById('quickProductCategory');
      categorySelect.innerHTML = '';
      // Get all categories (predefined + custom)
      const allCategories = [...Object.keys(categories), ...allData.filter(item => item.type === 'category').map(c => c.name)];
      
      // Sort and add
      [...new Set(allCategories)].sort((a, b) => a.localeCompare(b)).forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        categorySelect.appendChild(option);
      });

      // Populate stores
      populateStoreSelect('quickStore');
      
      openModal('quickAddModal');
      document.getElementById('quickProductName').value = '';
      document.getElementById('quickProductBrand').value = '';
      document.getElementById('quickProductIcon').value = '';
      document.getElementById('quickProductTags').value = '';
      document.getElementById('quickPrice').value = '';
      document.getElementById('quickQuantity').value = '1';
      document.getElementById('quickCalculatedPPU').textContent = `Price per unit: ${currencies[currentRegion]}0.00/kg`;
    }

    // Product action functions
    function duplicateProduct(productName) {
      // Find the custom product to duplicate (or create a temporary object for predefined)
      const customProduct = getCustomProductRecord(productName);
      
      let sourceProduct = customProduct;
      if (!sourceProduct) {
        // If it's predefined, create a mock object to read data from
        sourceProduct = {
            name: productName,
            brand: '',
            category: getProductCategory(productName),
            icon: getProductIcon(productName),
            tags: ''
        };
      }
      
      // Pre-fill the add product modal with the product data
      document.getElementById('newProductName').value = sourceProduct.name + ' (Copy)';
      document.getElementById('newProductBrand').value = sourceProduct.brand || '';
      document.getElementById('newProductCategory').value = sourceProduct.category;
      document.getElementById('newProductTags').value = sourceProduct.tags || '';
      document.getElementById('newProductIcon').value = sourceProduct.icon || '';
      
      populateProductCategories();
      // Select the correct category
      document.getElementById('newProductCategory').value = sourceProduct.category;
      
      openModal('addProductModal');
    }

    function editProduct(productName) {
      let customProduct = getCustomProductRecord(productName);
      // If it's a predefined product, create a custom version for editing
      if (!customProduct) {
        const category = getProductCategory(productName);
        const productIcon = getProductIcon(productName);
        customProduct = {
          id: generateId(), // Give it a temporary ID for tracking
          type: 'product',
          name: productName,
          brand: '',
          category: category,
          icon: productIcon,
          tags: '',
          isFavorite: false, // NEW: Default to false
          createdAt: new Date().toISOString(),
          __isNewCustomProduct: true // Flag to indicate this is a new custom product
        };
      }
      currentEditingProduct = customProduct;
      // Pre-fill the edit modal
      document.getElementById('editProductName').value = customProduct.name;
      document.getElementById('editProductBrand').value = customProduct.brand || '';
      document.getElementById('editProductIcon').value = customProduct.icon || '';
      document.getElementById('editProductTags').value = customProduct.tags || '';
      
      // Populate categories
      const select = document.getElementById('editProductCategory');
      select.innerHTML = '';
      const allCategories = [...Object.keys(categories), ...allData.filter(item => item.type === 'category').map(c => c.name)];
      
      [...new Set(allCategories)].sort((a, b) => a.localeCompare(b)).forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        select.appendChild(option);
      });
      // Set the current category
      select.value = customProduct.category;
      openModal('editProductModal');
    }

    function deleteProduct(productName) {
      const customProduct = getCustomProductRecord(productName);
      if (!customProduct) {
        showToast('Cannot delete predefined products', 'error');
        return;
      }
      currentDeletingItem = customProduct;
      
      // Count related items for warning message
      const relatedPrices = allData.filter(item => item.type === 'price' && item.name === productName).length;
      const relatedListItems = allData.filter(item => item.type === 'listItem' && item.name === productName).length;

      document.getElementById('deleteMessage').textContent =
        `Are you sure you want to delete "${productName}"? This will also delete ${relatedPrices} price record(s) and remove it from ${relatedListItems} shopping list item(s).`;
      openModal('deleteConfirmModal');
    }

    async function updateProduct() {
      if (!isAuthReady) { showToast("Please sign in to save data.", 'error'); return; }
      if (!currentEditingProduct) return;
      const name = document.getElementById('editProductName').value.trim();
      const brand = document.getElementById('editProductBrand').value.trim();
      const category = document.getElementById('editProductCategory').value;
      const icon = document.getElementById('editProductIcon').value.trim();
      const tagsInput = document.getElementById('editProductTags').value.trim();

      if (!name || !category) {
        showToast('Please fill required fields', 'error');
        return;
      }

      if (allData.length >= 999) {
        showToast('Maximum limit of 999 items reached. Please delete some items first.', 'error');
        return;
      }

      // Check if another product with same name and brand already exists
      const existingCustomProduct = allData.find(item =>
        item.type === 'product' &&
        item.id !== currentEditingProduct.id && // Exclude the current item being edited
        item.name.toLowerCase() === name.toLowerCase() &&
        (item.brand || '').toLowerCase() === (brand || '').toLowerCase()
      );

      // Check predefined products (only if no brand and name changed)
      let existingPredefinedProduct = false;
      if (!brand && name.toLowerCase() !== currentEditingProduct.name.toLowerCase()) {
        Object.values(categories).forEach(categoryData => {
          if (categoryData.products.some(product => product.toLowerCase() === name.toLowerCase())) {
            existingPredefinedProduct = true;
          }
        });
      }

      if (existingCustomProduct || existingPredefinedProduct) {
        showToast('Product with this name and brand already exists', 'error');
        return;
      }

      const oldName = currentEditingProduct.name;

      const updatedProduct = { ...currentEditingProduct,
        name: name,
        brand: brand,
        category: category,
        icon: icon,
        tags: tagsInput
      };

      // Remove the temporary flag
      delete updatedProduct.__isNewCustomProduct;

      let result;
      if (currentEditingProduct.__isNewCustomProduct) {
        // If it was a predefined product being saved for the first time
        result = await window.dataSdk.create(updatedProduct);
      } else {
        // Update existing custom product
        result = await window.dataSdk.update(updatedProduct);
      }

      if (result.isOk) {
        // If name or category changed, update all related records
        if (oldName !== name || currentEditingProduct.category !== category) {
          // Update all related prices with new name and category
          const relatedPrices = allData.filter(item => item.type === 'price' && item.name === oldName);
          for (const price of relatedPrices) {
            const updatedPrice = { ...price,
              name: name,
              category: category
            };
            await window.dataSdk.update(updatedPrice);
          }
          // Update all related list items with new name
          const relatedListItems = allData.filter(item => item.type === 'listItem' && item.name === oldName);
          for (const listItem of relatedListItems) {
            const updatedListItem = { ...listItem,
              name: name
            };
            await window.dataSdk.update(updatedListItem);
          }
        }
        
        showToast('Product updated successfully');
        closeModal('editProductModal');
        currentEditingProduct = null;
        // If we are on the product detail screen, update the current product name
        if (currentProduct === oldName) {
            currentProduct = name;
        }
      } else {
        showToast('Failed to update product', 'error');
      }
    }

    async function confirmDelete() {
      if (!isAuthReady) { showToast("Please sign in to save data.", 'error'); return; }
      if (!currentDeletingItem) return;
      try {
        const itemType = currentDeletingItem.type;
        const itemName = currentDeletingItem.name;
        
        if (itemType === 'product') {
            // Delete the product
            const deleteResult = await window.dataSdk.delete(currentDeletingItem);
            if (!deleteResult.isOk) {
              showToast('Failed to delete product', 'error');
              return;
            }
            // Delete all related prices
            const relatedPrices = allData.filter(item => item.type === 'price' && item.name === itemName);
            // Use batch delete
            await window.dataSdk.deleteBatch(relatedPrices);

            // Delete all related list items
            const relatedListItems = allData.filter(item => item.type === 'listItem' && item.name === itemName);
            // Use batch delete
            await window.dataSdk.deleteBatch(relatedListItems);

        } else if (itemType === 'store' && currentDeletingItem.isCustom) {
             // Delete all related prices for store
            const pricesToDelete = allData.filter(item => item.type === 'price' && item.store === itemName);
            // Use batch delete
            await window.dataSdk.deleteBatch(pricesToDelete);
            
            // Delete the store
            const deleteResult = await window.dataSdk.delete(currentDeletingItem);
            if (!deleteResult.isOk) {
                showToast('Failed to delete store', 'error');
                return;
            }
        } else if (itemType === 'category') {
            // Delete the category
            const deleteResult = await window.dataSdk.delete(currentDeletingItem);
            if (!deleteResult.isOk) {
                showToast('Failed to delete category', 'error');
                return;
            }
            // Note: We don't delete products/prices belonging to this category, just remove the category doc itself.
        }

        showToast('Item and related data deleted successfully');
        closeModal('deleteConfirmModal');
        currentDeletingItem = null;
      } catch (error) {
        showToast('Failed to delete item', 'error');
      }
    }

    // List management functions
    function editList(listId, listName) {
      if (!isAuthReady) { showToast("Please sign in to edit.", 'error'); return; }
      const list = allData.find(item => item.type === 'list' && item.id === listId);
      if (!list) return;
      currentEditingList = list;
      document.getElementById('editListName').value = listName;
      openModal('editListModal');
    }

    function deleteList(listId, listName) {
      if (!isAuthReady) { showToast("Please sign in to delete.", 'error'); return; }
      const list = allData.find(item => item.type === 'list' && item.id === listId);
      if (!list) return;
      currentDeletingList = list;
      document.getElementById('deleteListMessage').textContent =
        `Are you sure you want to delete "${listName}"?`;
      openModal('deleteListModal');
    }

    async function updateList() {
      if (!isAuthReady) { showToast("Please sign in to save data.", 'error'); return; }
      if (!currentEditingList) return;
      const name = document.getElementById('editListName').value.trim();
      if (!name) {
        showToast('Please enter list name', 'error');
        return;
      }

      // Check if another list with the same name exists
      const existingList = allData.find(item =>
        item.type === 'list' &&
        item.id !== currentEditingList.id &&
        item.name.toLowerCase() === name.toLowerCase()
      );

      if (existingList) {
        showToast('List name already in use', 'error');
        return;
      }
      
      const oldName = currentEditingList.name;

      const updatedList = { ...currentEditingList,
        name: name
      };

      const result = await window.dataSdk.update(updatedList);
      if (result.isOk) {
        showToast('List updated successfully');
        closeModal('editListModal');

        // Update current list name if we're viewing this list
        if (currentList === oldName) {
          currentList = name;
          updateHeader();
        }
        currentEditingList = null;
      } else {
        showToast('Failed to update list', 'error');
      }
    }

    async function confirmDeleteList() {
      if (!isAuthReady) { showToast("Please sign in to save data.", 'error'); return; }
      if (!currentDeletingList) return;
      try {
        // Delete all list items first
        const listItems = allData.filter(item => item.type === 'listItem' && item.listId === currentDeletingList.id);
        // Use batch delete
        await window.dataSdk.deleteBatch(listItems);
        
        // Delete the list
        const deleteResult = await window.dataSdk.delete(currentDeletingList);
        if (!deleteResult.isOk) {
          showToast('Failed to delete list', 'error');
          return;
        }
        showToast('List deleted successfully');
        closeModal('deleteListModal');

        // If we're currently viewing this list, go back to lists screen
        if (currentList === currentDeletingList.name) {
          currentList = '';
          switchScreen('lists');
        }
        currentDeletingList = null;
      } catch (error) {
        showToast('Failed to delete list', 'error');
      }
    }

    // Toast notification
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => {
        toast.style.animation = 'slideOutUp 0.3s ease-in-out';
        setTimeout(() => {
          document.body.removeChild(toast);
        }, 300);
      }, 3000);
    }
    
    // Final Helper for HTML events
    function getPredefinedProductData(productName) {
        let category = 'Unknown';
        let icon = productIcons[productName] || 'üì¶';
        for (const [catName, data] of Object.entries(categories)) {
            if (data.products.includes(productName)) {
                category = catName;
                break;
            }
        }
        return { name: productName, category, icon, brand: '', tags: '', isFavorite: false };
    }
    
    // Missing Helper function definitions (must be defined before exposure)
    function filterStores(query) {
        // Simple filtering logic applied within renderStores
        renderStores(); 
    }
    
    // NEW: Search Products for List
    function searchProductsForList(query) {
        const searchResults = document.getElementById('listSearchResults');
        const listItemsContainer = document.getElementById('listItemsContainer');
        const listTotalContainer = document.getElementById('listTotalContainer');

        if (!query.trim()) {
            searchResults.style.display = 'none';
            listItemsContainer.style.display = 'block';
            listTotalContainer.style.display = 'block';
            renderListItems(); // Re-render the actual list items
            return;
        }

        searchResults.style.display = 'block';
        listItemsContainer.style.display = 'none';
        listTotalContainer.style.display = 'none';
        searchResults.innerHTML = '';

        const lowerQuery = query.toLowerCase();
        let hasResults = false;

        // Search all products (predefined and custom)
        const allProductNames = getAllProductNames();
        const productMap = {}; 

        allProductNames.forEach(productName => {
            const customProduct = getCustomProductRecord(productName);
            const category = getProductCategory(productName);
            
            let searchText = productName.toLowerCase();
            if (customProduct) {
                searchText += ` ${customProduct.brand?.toLowerCase() || ''}`;
                searchText += ` ${customProduct.tags?.toLowerCase() || ''}`;
            }
            
            if (searchText.includes(lowerQuery)) {
                productMap[productName] = { 
                    name: productName, 
                    category: category, 
                    customProduct: customProduct 
                };
            }
        });
        
        const matchingProducts = Object.values(productMap);

        if (matchingProducts.length > 0) {
            hasResults = true;
            matchingProducts.forEach(product => {
                const productIcon = getProductIcon(product.name);
                const cheapestPrice = getCheapestPriceForProduct(product.name);
                
                const item = document.createElement('div');
                item.className = 'product-item list-style';
                item.style.cursor = 'pointer';
                item.innerHTML = `
                    <div class="product-icon" style="font-size: 1.2rem; margin-right: 0.5rem;">${productIcon}</div>
                    <div class="product-info">
                        <h3>${product.name}</h3>
                        <div class="product-meta">${product.category}</div>
                    </div>
                    <div class="price-info" style="min-width: 80px; text-align: right;">
                        ${cheapestPrice ? `<div class="price" style="font-weight: 500;">Cheapest: ${currencies[currentRegion]}${cheapestPrice.price.toFixed(2)}</div>` : `<div class="price">No Price</div>`}
                        <div class="ppu"><button class="btn btn-secondary" style="padding: 0.2rem 0.5rem; font-size: 0.8rem; height: auto;">+ Add to List</button></div>
                    </div>`;
                
                // Add click listener to the whole row
                item.addEventListener('click', () => {
                    window.openAddToListModal(product.name);
                    // Clear search after adding
                    document.getElementById('listProductSearch').value = '';
                    searchProductsForList(''); 
                });
                searchResults.appendChild(item);
            });
        }

        if (!hasResults) {
            searchResults.innerHTML = `<div class="empty-state"><div class="empty-icon">üîç</div><p>No products found for "${query}"</p></div>`;
        }
    }
    
    // NEW: Search Products for Favorites
    function searchProductsForFavorites(query) {
        const favoritesGrid = document.getElementById('favoritesList');
        const searchResults = document.getElementById('favoriteSearchResults');
        
        if (!query.trim()) {
            searchResults.style.display = 'none';
            favoritesGrid.style.display = 'grid';
            renderFavorites(); // Re-render the main favorites list
            return;
        }

        favoritesGrid.style.display = 'none';
        searchResults.style.display = 'grid';
        searchResults.innerHTML = '';
        
        const lowerQuery = query.toLowerCase();
        let hasResults = false;

        // Search all products (predefined and custom)
        const allProductNames = getAllProductNames();
        const productMap = {}; 

        allProductNames.forEach(productName => {
            const customProduct = getCustomProductRecord(productName);
            const category = getProductCategory(productName);
            
            let searchText = productName.toLowerCase();
            if (customProduct) {
                searchText += ` ${customProduct.brand?.toLowerCase() || ''}`;
                searchText += ` ${customProduct.tags?.toLowerCase() || ''}`;
            }
            
            if (searchText.includes(lowerQuery)) {
                productMap[productName] = { 
                    name: productName, 
                    category: category, 
                    customProduct: customProduct 
                };
            }
        });
        
        const matchingProducts = Object.values(productMap);

        if (matchingProducts.length > 0) {
            hasResults = true;
            matchingProducts.forEach(product => {
                const productName = product.name;
                const prices = allData.filter(item => item.type === 'price' && item.name === productName);
                const cheapestPrice = getCheapestPrice(prices);
                const productIcon = getProductIcon(productName);
                const customProduct = product.customProduct;
                const isFavorite = customProduct?.isFavorite || false;
                
                // Use product-item structure for rich detail
                const item = document.createElement('div');
                item.className = 'product-item'; 
                item.innerHTML = `
                    <button class="action-btn favorite" 
                            onclick="event.stopPropagation(); window.toggleFavorite('${productName.replace(/'/g, "\\'")}')">
                        ${isFavorite ? '‚òÖ' : '‚òÜ'}
                    </button>
                    <div class="product-actions" style="opacity: 1;">
                        <button class="action-btn add" onclick="event.stopPropagation(); window.openAddToListModal('${productName.replace(/'/g, "\\'")}')">+</button>
                    </div>
                    <div class="product-icon">${productIcon}</div>
                    <div class="product-info">
                        <h3>${productName}</h3>
                        <div class="product-meta">${product.category}</div>
                    </div>
                    <div class="price-info">
                        ${cheapestPrice ? `<div class="price">${currencies[currentRegion]}${cheapestPrice.price.toFixed(2)}</div>` : `<div class="price">No price</div>`}
                    </div>
                    `;
                item.addEventListener('click', (e) => {
                    if (!e.target.closest('.action-btn')) {
                        showProductDetail(productName);
                    }
                });
                searchResults.appendChild(item);
            });
        }

        if (!hasResults) {
            searchResults.innerHTML = `<div class="empty-state col-span-4"><div class="empty-icon">üîç</div><p>No products found for "${query}"</p></div>`;
        }
    }
    
    async function confirmAddToList() {
        if (!isAuthReady) { showToast("Please sign in to save data.", 'error'); return; }

        const productName = selectedProductForList;
        const quantity = parseInt(document.getElementById('listQuantity').value);
        const existingListId = document.getElementById('existingListSelect').value;
        const newListName = document.getElementById('quickListName').value.trim();

        let listIdToUse = existingListId;

        if (!productName || isNaN(quantity) || quantity <= 0) {
            showToast('Invalid product or quantity.', 'error');
            return;
        }
        
        const existingListGroupVisible = document.getElementById('existingListGroup').style.display !== 'none';
        const newListGroupVisible = document.getElementById('newListGroup').style.display !== 'none';

        if (existingListGroupVisible && existingListId) {
            // Path 1: Adding to existing list
            listIdToUse = existingListId;
            
        } else if (newListGroupVisible && newListName) {
            // Path 2: Creating new list and adding item
            
            // 2a. Check for name conflict before creating
            const existingList = allData.find(item =>
                item.type === 'list' && item.name.toLowerCase() === newListName.toLowerCase()
            );
            if (existingList) {
                showToast(`List name "${newListName}" already exists.`, 'error');
                return;
            }

            // 2b. Create the new list document
            const newListData = {
                type: 'list',
                name: newListName,
                createdAt: new Date().toISOString()
            };
            const listResult = await window.dataSdk.create(newListData);
            
            if (!listResult.isOk) {
                showToast('Failed to create new list.', 'error');
                return;
            }
            listIdToUse = listResult.id;
            
        } else {
            showToast('Please select an existing list or enter a name for a new list.', 'error');
            return;
        }
        
        // 3. Check for item duplicates in the target list
        const existingItem = allData.find(item =>
            item.type === 'listItem' &&
            item.listId === listIdToUse &&
            item.name === productName
        );
        if (existingItem) {
            showToast(`${productName} is already on this list. Please adjust quantity on the list screen.`, 'error');
            return;
        }

        // 4. Create the list item document
        const productCategory = getProductCategory(productName);
        const listItemData = {
            type: 'listItem',
            name: productName,
            listId: listIdToUse,
            itemQuantity: quantity,
            checked: false,
            category: productCategory,
            createdAt: new Date().toISOString()
        };

        const itemResult = await window.dataSdk.create(listItemData);
        
        if (itemResult.isOk) {
            showToast(`${productName} added to list successfully!`);
            closeModal('addToListModal');
            // Clean up inputs
            document.getElementById('quickListName').value = '';
            document.getElementById('listQuantity').value = '1';
        } else {
            showToast('Failed to add item to list.', 'error');
        }
    }
    
    // List management functions
    function populateExistingLists() {
        const select = document.getElementById('existingListSelect');
        select.innerHTML = '';
        const existingLists = allData.filter(item => item.type === 'list');
        
        if (existingLists.length === 0) {
            select.innerHTML = '<option value="">No lists found</option>';
            document.getElementById('confirmAddToListBtn').disabled = true;
            return;
        }

        existingLists.forEach(list => {
            const option = document.createElement('option');
            option.value = list.id;
            option.textContent = list.name;
            select.appendChild(option);
        });
        document.getElementById('confirmAddToListBtn').disabled = false;
    }

    // Utility to generate unique ID (needed for local mocks/predefined logic)
    function generateId() {
        return Math.random().toString(36).substring(2, 9);
    }

    // EXPOSE FUNCTIONS TO GLOBAL SCOPE FOR INLINE HTML HANDLERS (CRITICAL FIX)
    // All functions called from onclick="..." must be exposed here.
    window.toggleFavorite = toggleFavorite;
    window.openAddToListModal = openAddToListModal;
    window.duplicateProduct = duplicateProduct;
    window.editProduct = editProduct;
    window.deleteProduct = deleteProduct;
    window.moveList = moveList;
    window.editList = editList;
    window.deleteList = deleteList;
    window.openEditStoreModal = openEditStoreModal;
    window.duplicateStore = duplicateStore;
    window.deleteStore = deleteStore;
    window.toggleListItem = toggleListItem; 
    window.adjustListItemQuantity = adjustListItemQuantity;
    window.deleteListItem = deleteListItem;
    window.addSuggestedItemToList = addSuggestedItemToList;
    window.toggleGrouping = toggleGrouping; 
    window.showProductSuggestions = showProductSuggestions; 
    window.filterStores = filterStores; 
    window.confirmAddToList = confirmAddToList; 
    window.openQuickAddModal = openQuickAddModal; 
    window.populateExistingLists = populateExistingLists; 
    // The test function is removed as requested.


    // Initialize app when DOM is loaded
    document.addEventListener('DOMContentLoaded', initApp);
  </script>

</body>

</html>
